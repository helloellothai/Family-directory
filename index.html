<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Directory</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196f3 0%, #9c27b0 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .family-name-setup {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .family-name-setup button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .startup-screen {
            padding: 40px;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .startup-option {
            background: white;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .startup-option:hover {
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .startup-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 100%;
            font-size: 16px;
        }

        .startup-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            padding: 10px;
        }

        .tab {
            background: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            background: #2196f3;
            color: white;
        }

        .controls {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .content {
            padding: 30px;
        }

        .form-section {
            max-width: 800px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        label.optional {
            color: #666;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: Arial, sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2196f3;
        }

        textarea {
            resize: vertical;
            height: 60px;
        }

        .big-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            margin-right: 15px;
        }

        .big-btn.gray {
            background: #757575;
        }

        .family-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .family-list .person-entry {
            margin-bottom: 12px !important;
            padding: 6px !important;
            border-radius: 6px;
            background: #fafafa;
        }

        .family-list .person-first-line {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            line-height: 1.1 !important;
            margin-bottom: 2px !important;
        }

        .small-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 1px 4px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 8px;
            font-weight: 600;
            pointer-events: auto;
            z-index: 999;
            position: relative;
        }

        .small-btn.red {
            background: #f44336;
        }

        .family-list .person-details {
            font-size: 14px;
            color: #666;
            margin-top: 1px !important;
            line-height: 1.1 !important;
        }

        .family-list .health-info {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 6px;
            padding: 6px !important;
            margin-top: 2px !important;
            font-size: 12px;
            line-height: 1.1 !important;
        }

        .health-title {
            color: #c62828;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .address-item {
            margin-bottom: 1px;
            padding: 6px;
            background: #f9f9f9;
            border-radius: 4px;
            line-height: 1.2;
        }

        .calendar-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }

        .month-header {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        .month-header:first-child {
            margin-top: 0;
        }

        .calendar-item {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            line-height: 1.4;
        }

        .calendar-item:last-child {
            border-bottom: none;
        }

        .phone-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }

        .phone-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .phone-item:last-child {
            border-bottom: none;
        }

        .phone-name {
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin: 2px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Startup Screen -->
        <div id="startup-screen" class="startup-screen">
            <h1 style="color: #2196f3; margin-bottom: 30px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Directory</h1>
            
            <div class="startup-option" onclick="showCreateForm()">
                <h3>üÜï Create New Family Directory</h3>
                <p>Start a new family directory and invite family members</p>
            </div>
            
            <div class="startup-option" onclick="showJoinForm()">
                <h3>üîó Join Existing Directory</h3>
                <p>Enter an invite code to join a family directory</p>
            </div>

            <!-- Create Form -->
            <div id="create-form" style="display: none; margin-top: 30px;">
                <h3>Create New Directory</h3>
                <input type="text" id="new-family-name" class="startup-input" placeholder="Enter family name (e.g., Smith Family)">
                <button class="startup-button" onclick="createDirectory()">Create Directory</button>
                <button class="startup-button" style="background: #757575;" onclick="hideStartupForms()">Cancel</button>
            </div>

            <!-- Join Form -->
            <div id="join-form" style="display: none; margin-top: 30px;">
                <h3>Join Directory</h3>
                <input type="text" id="invite-code" class="startup-input" placeholder="Enter invite code (e.g., SMITH2024)">
                <button class="startup-button" onclick="joinDirectory()">Join Directory</button>
                <button class="startup-button" style="background: #757575;" onclick="hideStartupForms()">Cancel</button>
            </div>
        </div>

        <!-- Main App (hidden initially) -->
        <div id="main-app" style="display: none;">
            <!-- Header -->
            <div class="header">
                <div class="family-name-setup">
                    <button onclick="leaveDirectory()" style="background: rgba(255,0,0,0.3);">Leave Directory</button>
                    <button onclick="showInviteCode()" style="background: rgba(0,255,0,0.3);">Share Code</button>
                </div>
                <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ <span id="directory-title">Family Directory</span></h1>
                <p>Collaborative family information sharing</p>
                <p style="font-size: 14px; margin-top: 5px;">Invite Code: <strong id="current-invite-code"></strong></p>
            </div>

            <!-- Navigation Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('directory')">üìã Family Directory</button>
                <button class="tab" onclick="showTab('add')">‚ûï Add/Edit Person</button>
                <button class="tab" onclick="showTab('birthday-calendar')">üéÇ Birthday Calendar</button>
                <button class="tab" onclick="showTab('anniversary-calendar')">üíç Anniversary Calendar</button>
                <button class="tab" onclick="showTab('addresses')">üè† Addresses</button>
                <button class="tab" onclick="showTab('health')">üè• Health Information</button>
                <button class="tab" onclick="showTab('phone-list')">üìû Phone List</button>
            </div>

            <!-- Controls -->
            <div class="controls">
                <span style="color: #666; font-size: 14px;">
                    üåê Updates automatically when family members make changes
                </span>
            </div>

            <!-- Main Content -->
            <div class="content">
                
                <!-- Add/Edit Tab -->
                <div id="add-tab" class="tab-content" style="display: none;">
                    <h2 id="form-title">‚ûï Add New Family Member</h2>
                    <br>
                    
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label>üë§ Full Name *</label>
                                <input type="text" id="fullName">
                            </div>
                            <div class="form-group">
                                <label class="optional">‚ú® Preferred Name</label>
                                <input type="text" id="preferredName" placeholder="What they like to be called">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üí∞ Maiden Name (if applicable)</label>
                                <input type="text" id="maidenName">
                            </div>
                            <div class="form-group">
                                <label>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Who is their parent?</label>
                                <select id="parentId">
                                    <option value="">Select parent (or leave blank if this is a parent)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üíï Spouse (if married)</label>
                                <select id="spouseId">
                                    <option value="">Select spouse (or leave blank if single)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>üéÇ Birthday * (Required)</label>
                                <input type="date" id="birthday" required style="border-color: #f44336;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üíç Anniversary (if married)</label>
                                <input type="date" id="anniversary">
                            </div>
                            <div class="form-group">
                                <label class="optional">‚ö∞Ô∏è Date of Death (if deceased)</label>
                                <input type="date" id="dateOfDeath">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üì± Phone Number</label>
                                <input type="tel" id="phone" placeholder="555-123-4567">
                            </div>
                            <div class="form-group">
                                <label class="optional">‚úâÔ∏è Email</label>
                                <input type="email" id="email">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üì∑ Instagram Handle</label>
                                <input type="text" id="instagram" placeholder="@username">
                            </div>
                            <div class="form-group">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="optional">üè† Address</label>
                            <textarea id="address"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="optional">üè• Health Notes (Private - only for family)</label>
                            <textarea id="healthInfo"></textarea>
                        </div>

                        <div style="margin-top: 30px;">
                            <button class="big-btn" onclick="addOrUpdateMember()" id="submit-btn">‚ûï Add to Family</button>
                            <button class="big-btn gray" onclick="clearForm()">üîÑ Clear Form</button>
                        </div>
                    </div>
                </div>

                <!-- Directory Tab -->
                <div id="directory-tab" class="tab-content">
                    <h2>üìã Family Members (<span id="member-count">0</span>)</h2>
                    <br>
                    <div class="family-list" id="family-list"></div>
                </div>

                <!-- Health Information Tab -->
                <div id="health-tab" class="tab-content" style="display: none;">
                    <h2>üè• Health Information</h2>
                    <br>
                    <div id="health-list"></div>
                </div>

                <!-- Birthday Calendar Tab -->
                <div id="birthday-calendar-tab" class="tab-content" style="display: none;">
                    <h2>üéÇ Birthday Calendar</h2>
                    <p style="color: #666; margin-bottom: 20px;">All family birthdays organized by month</p>
                    <div class="calendar-list" id="birthday-calendar-list"></div>
                </div>

                <!-- Anniversary Calendar Tab -->
                <div id="anniversary-calendar-tab" class="tab-content" style="display: none;">
                    <h2>üíç Anniversary Calendar</h2>
                    <p style="color: #666; margin-bottom: 20px;">All family anniversaries organized by month</p>
                    <div class="calendar-list" id="anniversary-calendar-list"></div>
                </div>

                <!-- Addresses Tab -->
                <div id="addresses-tab" class="tab-content" style="display: none;">
                    <h2>üè† Family Addresses</h2>
                    <br>
                    <div id="addresses-list"></div>
                </div>

                <!-- Phone List Tab -->
                <div id="phone-list-tab" class="tab-content" style="display: none;">
                    <h2>üìû Phone Directory</h2>
                    <p style="color: #666; margin-bottom: 20px;">All family members alphabetically by first name with phone numbers</p>
                    <div class="phone-list" id="phone-directory-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ydsgjlsbbwsxzjewktbk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlkc2dqbHNiYndzeHpqZXdrdGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTc1OTEsImV4cCI6MjA2OTU5MzU5MX0.WfvHuhKdieJbLocKbv2oosBKzKl1dsZu50mA9OUHRtA';
        
        // Initialize Supabase
        let supabase;
        window.addEventListener('load', function() {
            try {
                if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('‚úÖ Supabase connected successfully');
                } else {
                    console.error('‚ùå Supabase library not loaded');
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize Supabase:', error);
            }
        });

        // Global variables
        let familyMembers = [];
        let editingId = null;
        let currentDirectoryId = null;
        let currentDirectoryName = '';
        let currentInviteCode = '';
        let isSubmitting = false;

        // Startup functions
        function showCreateForm() {
            console.log('showCreateForm called');
            document.getElementById('create-form').style.display = 'block';
            document.getElementById('join-form').style.display = 'none';
        }

        function showJoinForm() {
            console.log('showJoinForm called');
            document.getElementById('join-form').style.display = 'block';
            document.getElementById('create-form').style.display = 'none';
        }

        function hideStartupForms() {
            document.getElementById('create-form').style.display = 'none';
            document.getElementById('join-form').style.display = 'none';
        }

        async function createDirectory() {
            const familyName = document.getElementById('new-family-name').value.trim();
            if (!familyName) {
                alert('Please enter a family name');
                return;
            }

            if (!supabase) {
                alert('Database connection not available. Please refresh the page.');
                return;
            }

            try {
                // Generate unique invite code
                const inviteCode = familyName.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 8) + 
                                 Math.floor(Math.random() * 1000);

                // Use direct fetch to avoid cloning issues
                const response = await fetch(`${SUPABASE_URL}/rest/v1/family_directories`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        name: familyName + ' Directory',
                        invite_code: inviteCode
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Join the directory we just created
                await joinDirectoryById(data[0].id, data[0].name, data[0].invite_code);
                
                // Show the invite code in a more visible way
                setTimeout(() => {
                    showInviteCode();
                }, 500);

            } catch (error) {
                console.error('Error creating directory:', error);
                alert('Error creating directory: ' + error.message);
            }
        }

        async function joinDirectory() {
            const inviteCode = document.getElementById('invite-code').value.trim().toUpperCase();
            if (!inviteCode) {
                alert('Please enter an invite code');
                return;
            }

            if (!supabase) {
                alert('Database connection not available. Please refresh the page.');
                return;
            }

            try {
                // Use direct fetch
                const response = await fetch(`${SUPABASE_URL}/rest/v1/family_directories?invite_code=eq.${inviteCode}&select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data || data.length === 0) {
                    alert('Invalid invite code. Please check and try again.');
                    return;
                }

                await joinDirectoryById(data[0].id, data[0].name, data[0].invite_code);
                alert('‚úÖ Successfully joined family directory!');

            } catch (error) {
                console.error('Error joining directory:', error);
                alert('Error joining directory. Please try again.');
            }
        }

        async function joinDirectoryById(directoryId, directoryName, inviteCode) {
            currentDirectoryId = directoryId;
            currentDirectoryName = directoryName;
            currentInviteCode = inviteCode;

            // Update UI
            document.getElementById('directory-title').textContent = directoryName;
            document.getElementById('current-invite-code').textContent = inviteCode;
            document.getElementById('startup-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            // Load family data from database
            await loadFamilyData();
            updateDropdowns();
            updateAllViews();

            // Set up real-time subscriptions
            setupRealtimeSubscription();
        }

        // Load family data from Supabase
        async function loadFamilyData() {
            if (!currentDirectoryId || !supabase) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/family_members?directory_id=eq.${currentDirectoryId}&select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                familyMembers = await response.json() || [];
                console.log(`‚úÖ Loaded ${familyMembers.length} family members`);
            } catch (error) {
                console.error('Error loading family data:', error);
                familyMembers = [];
            }
        }

        // Set up real-time subscription
        function setupRealtimeSubscription() {
            if (!supabase || !currentDirectoryId) return;
            
            supabase
                .channel('family_members_changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'family_members',
                        filter: `directory_id=eq.${currentDirectoryId}`
                    }, 
                    async (payload) => {
                        console.log('üîÑ Real-time update received:', payload);
                        await loadFamilyData();
                        updateDropdowns();
                        updateAllViews();
                    }
                )
                .subscribe();
        }

        function leaveDirectory() {
            if (confirm('Are you sure you want to leave this family directory?')) {
                currentDirectoryId = null;
                currentDirectoryName = '';
                currentInviteCode = '';
                familyMembers = [];
                
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('startup-screen').style.display = 'block';
                hideStartupForms();
            }
        }

        function showInviteCode() {
            // Create a persistent modal instead of a quick alert
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 15px;
                text-align: center;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h2 style="color: #2196f3; margin-bottom: 20px;">üì§ Share Your Family Directory</h2>
                <p style="margin-bottom: 20px; font-size: 16px;">Share this invite code with family members:</p>
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #2196f3;">
                    <h1 style="color: #1976d2; font-size: 2.5rem; letter-spacing: 3px; margin: 0;">${currentInviteCode}</h1>
                </div>
                <p style="margin: 20px 0; color: #666; font-size: 14px;">
                    Family members can join by going to this website and clicking<br>
                    "Join Existing Directory" then entering this code.
                </p>
                <button onclick="copyInviteCode()" style="
                    background: #4caf50; 
                    color: white; 
                    border: none; 
                    padding: 15px 30px; 
                    border-radius: 8px; 
                    font-size: 16px; 
                    margin: 10px; 
                    cursor: pointer;
                ">üìã Copy Code</button>
                <button onclick="closeInviteModal()" style="
                    background: #757575; 
                    color: white; 
                    border: none; 
                    padding: 15px 30px; 
                    border-radius: 8px; 
                    font-size: 16px; 
                    margin: 10px; 
                    cursor: pointer;
                ">‚úñÔ∏è Close</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            modal.id = 'invite-modal';
            
            // Close when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeInviteModal();
                }
            });
        }

        function copyInviteCode() {
            navigator.clipboard.writeText(currentInviteCode).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.style.background = '#4caf50';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#4caf50';
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = currentInviteCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Code copied to clipboard!');
            });
        }

        function closeInviteModal() {
            const modal = document.getElementById('invite-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Helper function to find someone's spouse
        function findSpouse(person) {
            if (!person || !person.spouse_id) return null;
            return familyMembers.find(member => member.id == person.spouse_id);
        }

        // Format phone number with dashes
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 10) {
                return digits.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            }
            return phone;
        }

        // Fix date display to prevent day shifting
        function formatDateDisplay(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            const date = new Date(year, month, day);
            return date.toLocaleDateString();
        }

        // Fix date for calendar sorting
        function getDateForSorting(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            return new Date(year, month, day);
        }

        // Update parent and spouse dropdowns
        function updateDropdowns() {
            updateParentDropdown();
            updateSpouseDropdown();
        }

        // Update parent dropdown
        function updateParentDropdown() {
            const select = document.getElementById('parentId');
            const currentValue = select.value;
            
            const parents = familyMembers.filter(member => {
                if (member.id === editingId) return false;
                if (!member.birthday) return true;
                const age = calculateAge(member.birthday);
                return age >= 15;
            });
            
            let options = '<option value="">Select parent (or leave blank if this is a parent)</option>';
            
            const processedIds = new Set();
            parents.forEach(parent => {
                if (processedIds.has(parent.id)) return;
                
                const spouse = findSpouse(parent);
                
                if (spouse && parents.some(p => p.id == spouse.id)) {
                    const name1 = getSimpleDisplayName(parent);
                    const name2 = getSimpleDisplayName(spouse);
                    options += `<option value="${parent.id}">${name1} & ${name2}</option>`;
                    processedIds.add(parent.id);
                    processedIds.add(spouse.id);
                } else {
                    options += `<option value="${parent.id}">${getSimpleDisplayName(parent)}</option>`;
                    processedIds.add(parent.id);
                }
            });
            
            select.innerHTML = options;
            select.value = currentValue;
        }

        // Update spouse dropdown
        function updateSpouseDropdown() {
            const select = document.getElementById('spouseId');
            const currentValue = select.value;
            
            let options = '<option value="">Select spouse (or leave blank if single)</option>';
            familyMembers.forEach(member => {
                if (member.id !== editingId) {
                    options += `<option value="${member.id}">${getDisplayNameWithLastName(member)}</option>`;
                }
            });
            
            select.innerHTML = options;
            select.value = currentValue;
        }

        // Get display name with last name for dropdowns
        function getDisplayNameWithLastName(member) {
            const fullNameParts = member.full_name.trim().split(' ');
            const lastName = fullNameParts[fullNameParts.length - 1];
            
            if (member.preferred_name && member.preferred_name.trim()) {
                return `${member.preferred_name.trim()} ${lastName}`;
            } else {
                return member.full_name;
            }
        }

        // Get simple display name for most views
        function getSimpleDisplayName(member) {
            const fullNameParts = member.full_name.trim().split(' ');
            const lastName = fullNameParts[fullNameParts.length - 1];
            
            if (member.preferred_name && member.preferred_name.trim()) {
                return `${member.preferred_name.trim()} ${lastName}`;
            } else {
                return member.full_name;
            }
        }

        // Show tab
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.style.display = 'none');
            
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            const clickedButton = Array.from(tabButtons).find(btn => 
                btn.textContent.includes(getTabDisplayName(tabName))
            );
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            if (tabName === 'add' && !editingId) {
                clearForm();
            }
        }

        // Helper function to get tab display name
        function getTabDisplayName(tabName) {
            const tabNames = {
                'directory': 'Family Directory',
                'add': 'Add/Edit Person',
                'birthday-calendar': 'Birthday Calendar',
                'anniversary-calendar': 'Anniversary Calendar',
                'addresses': 'Addresses',
                'health': 'Health Information',
                'phone-list': 'Phone List'
            };
            return tabNames[tabName] || tabName;
        }

        // Clear form
        function clearForm() {
            document.getElementById('fullName').value = '';
            document.getElementById('preferredName').value = '';
            document.getElementById('maidenName').value = '';
            document.getElementById('parentId').value = '';
            document.getElementById('spouseId').value = '';
            document.getElementById('birthday').value = '';
            document.getElementById('anniversary').value = '';
            document.getElementById('dateOfDeath').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('email').value = '';
            document.getElementById('instagram').value = '';
            document.getElementById('address').value = '';
            document.getElementById('healthInfo').value = '';
            
            editingId = null;
            document.getElementById('form-title').textContent = '‚ûï Add New Family Member';
            document.getElementById('submit-btn').textContent = '‚ûï Add to Family';
            
            updateDropdowns();
        }

        // Add or update member (temporary local storage for testing)
        function addOrUpdateMember() {
            if (isSubmitting) return;
            isSubmitting = true;
            
            const fullName = document.getElementById('fullName').value.trim();
            const birthday = document.getElementById('birthday').value;

            if (!fullName || !birthday) {
                alert('Please fill in:\n‚Ä¢ Full Name\n‚Ä¢ Birthday\n\nThese are required fields.');
                isSubmitting = false;
                return;
            }

            const memberData = {
                id: editingId || Date.now().toString(),
                full_name: fullName,
                preferred_name: document.getElementById('preferredName').value.trim() || null,
                maiden_name: document.getElementById('maidenName').value.trim() || null,
                parent_id: document.getElementById('parentId').value || null,
                spouse_id: document.getElementById('spouseId').value || null,
                birthday: birthday,
                anniversary: document.getElementById('anniversary').value || null,
                date_of_death: document.getElementById('dateOfDeath').value || null,
                phone: formatPhoneNumber(document.getElementById('phone').value.trim()) || null,
                email: document.getElementById('email').value.trim() || null,
                instagram: document.getElementById('instagram').value.trim() || null,
                address: document.getElementById('address').value.trim() || null,
                health_info: document.getElementById('healthInfo').value.trim() || null
            };

            if (editingId) {
                // Update existing member
                const memberIndex = familyMembers.findIndex(m => m.id == editingId);
                if (memberIndex !== -1) {
                    familyMembers[memberIndex] = memberData;
                }
                alert('‚úÖ Family member updated successfully!');
            } else {
                // Add new member
                familyMembers.push(memberData);
                alert('‚úÖ Family member added successfully!');
            }

            // Auto-sync spouse data
            if (memberData.spouse_id) {
                const spouseIndex = familyMembers.findIndex(m => m.id == memberData.spouse_id);
                if (spouseIndex !== -1) {
                    familyMembers[spouseIndex].spouse_id = memberData.id;
                    if (memberData.anniversary) {
                        familyMembers[spouseIndex].anniversary = memberData.anniversary;
                    }
                }
            }

            clearForm();
            updateDropdowns();
            updateAllViews();
            isSubmitting = false;
        }

        // Edit member
        function editMember(id) {
            const member = familyMembers.find(m => m.id == id);
            if (!member) return;

            editingId = id;
            
            document.getElementById('fullName').value = member.full_name || '';
            document.getElementById('preferredName').value = member.preferred_name || '';
            document.getElementById('maidenName').value = member.maiden_name || '';
            document.getElementById('parentId').value = member.parent_id || '';
            document.getElementById('spouseId').value = member.spouse_id || '';
            document.getElementById('birthday').value = member.birthday || '';
            document.getElementById('anniversary').value = member.anniversary || '';
            document.getElementById('dateOfDeath').value = member.date_of_death || '';
            document.getElementById('phone').value = member.phone || '';
            document.getElementById('email').value = member.email || '';
            document.getElementById('instagram').value = member.instagram || '';
            document.getElementById('address').value = member.address || '';
            document.getElementById('healthInfo').value = member.health_info || '';
            
            const displayName = getSimpleDisplayName(member);
            document.getElementById('form-title').textContent = `‚úèÔ∏è Edit ${displayName}`;
            document.getElementById('submit-btn').textContent = 'üíæ Save Changes';
            
            updateDropdowns();
            showTab('add');
        }

        // Delete member
        function deleteMember(memberId) {
            if (!confirm('Are you sure you want to remove this family member?')) return;

            const memberIndex = familyMembers.findIndex(m => m.id == memberId);
            if (memberIndex !== -1) {
                familyMembers.splice(memberIndex, 1);
                updateDropdowns();
                updateAllViews();
                alert('‚úÖ Family member removed successfully!');
            }
        }

        // Calculate age
        function calculateAge(birthday, dateOfDeath = null) {
            if (!birthday) return 'Unknown';
            const today = new Date();
            const birthDate = new Date(birthday);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Get display name with death indicator
        function getDisplayName(member) {
            let name = member.full_name;
            if (member.preferred_name && member.preferred_name !== member.full_name) {
                name += ` - ${member.preferred_name}`;
            }
            if (member.maiden_name) {
                name += ` (n√©e ${member.maiden_name})`;
            }
            return name;
        }

        // Update all views
        function updateAllViews() {
            updateDirectoryView();
            updateBirthdayCalendarView();
            updateAnniversaryCalendarView();
            updateAddressesView();
            updateHealthView();
            updatePhoneListView();
        }

        // Build family tree grouped by generation
        function buildFamilyTree() {
            const directoryLastName = currentDirectoryName.replace(' Directory', '');
            const processedIds = new Set();
            const orderedFamilyList = [];

            const directoryFamilyMembers = familyMembers.filter(member => {
                const lastName = member.full_name.trim().split(' ').pop();
                const maidenName = member.maiden_name;
                return lastName === directoryLastName || maidenName === directoryLastName;
            });

            const topLevelParents = directoryFamilyMembers.filter(member => !member.parent_id);
            
            topLevelParents.sort((a, b) => {
                if (!a.birthday && !b.birthday) return 0;
                if (!a.birthday) return 1;
                if (!b.birthday) return -1;
                return new Date(a.birthday) - new Date(b.birthday);
            });

            topLevelParents.forEach(person => {
                if (processedIds.has(person.id)) return;

                orderedFamilyList.push(person);
                processedIds.add(person.id);

                if (person.spouse_id) {
                    const spouse = familyMembers.find(s => s.id == person.spouse_id);
                    if (spouse && !processedIds.has(spouse.id)) {
                        orderedFamilyList.push(spouse);
                        processedIds.add(spouse.id);
                    }
                }

                const addDescendants = (parentId) => {
                    const children = familyMembers.filter(m => m.parent_id == parentId);
                    
                    children.sort((a, b) => {
                        if (!a.birthday && !b.birthday) return 0;
                        if (!a.birthday) return 1;
                        if (!b.birthday) return -1;
                        return new Date(a.birthday) - new Date(b.birthday);
                    });

                    children.forEach(child => {
                        if (!processedIds.has(child.id)) {
                            orderedFamilyList.push(child);
                            processedIds.add(child.id);

                            if (child.spouse_id) {
                                const spouse = familyMembers.find(s => s.id == child.spouse_id);
                                if (spouse && !processedIds.has(spouse.id)) {
                                    orderedFamilyList.push(spouse);
                                    processedIds.add(spouse.id);
                                }
                            }

                            addDescendants(child.id);
                        }
                    });
                };

                addDescendants(person.id);
            });

            const otherFamilies = familyMembers.filter(member => !processedIds.has(member.id));
            const otherFamilyGroups = {};
            otherFamilies.forEach(member => {
                const lastName = member.full_name.trim().split(' ').pop();
                if (!otherFamilyGroups[lastName]) {
                    otherFamilyGroups[lastName] = [];
                }
                otherFamilyGroups[lastName].push(member);
            });

            Object.keys(otherFamilyGroups).sort().forEach(familyName => {
                const members = otherFamilyGroups[familyName];
                
                members.sort((a, b) => {
                    if (!a.birthday && !b.birthday) return 0;
                    if (!a.birthday) return 1;
                    if (!b.birthday) return -1;
                    return new Date(a.birthday) - new Date(b.birthday);
                });

                members.forEach(member => {
                    if (!processedIds.has(member.id)) {
                        orderedFamilyList.push(member);
                        processedIds.add(member.id);
                    }
                });
            });

            return orderedFamilyList;
        }

        // Update directory view
        function updateDirectoryView() {
            const list = document.getElementById('family-list');
            const count = document.getElementById('member-count');
            
            count.textContent = familyMembers.length;

            if (familyMembers.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <p style="font-size: 20px; margin-bottom: 8px;">No family members added yet</p>
                        <p>Click "Add/Edit Person" above to get started!</p>
                    </div>
                `;
                return;
            }

            const orderedFamily = buildFamilyTree();
            
            let html = '';
            orderedFamily.forEach(member => {
                const displayName = getDisplayName(member);
                const formattedBirthday = member.birthday ? formatDateDisplay(member.birthday) : 'No birthday recorded';
                
                let nameAndDate = `${displayName} - ${formattedBirthday}`;
                if (member.date_of_death) {
                    const deathDate = formatDateDisplay(member.date_of_death);
                    const wouldBeAge = calculateAge(member.birthday, member.date_of_death);
                    nameAndDate += `, died ${deathDate} - would be ${wouldBeAge}`;
                }
                
                let detailsParts = [];
                if (member.address) detailsParts.push(member.address);
                if (member.phone) detailsParts.push(member.phone);
                if (member.anniversary) detailsParts.push(`Anniversary: ${formatDateDisplay(member.anniversary)}`);
                if (member.email) detailsParts.push(member.email);
                if (member.instagram) detailsParts.push(member.instagram);
                
                const editOnclick = `editMember('${member.id}')`;
                const deleteOnclick = `deleteMember('${member.id}')`;
                
                html += `
                    <div class="person-entry">
                        <div class="person-first-line">
                            ${nameAndDate} 
                            <button class="small-btn" onclick="${editOnclick}">‚úèÔ∏è</button>
                            <button class="small-btn red" onclick="${deleteOnclick}">üóëÔ∏è</button>
                        </div>
                        ${detailsParts.length > 0 ? `<div class="person-details">${detailsParts.join(' ‚Ä¢ ')}</div>` : ''}
                        ${member.health_info ? `
                            <div class="health-info">
                                <div class="health-title">üè• Health Information</div>
                                <div>${member.health_info}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // Update health view
        function updateHealthView() {
            const list = document.getElementById('health-list');
            const membersWithHealth = familyMembers.filter(member => member.health_info && member.health_info.trim());
            
            if (membersWithHealth.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üè•</div>
                        <p style="font-size: 20px;">No health information recorded yet</p>
                        <p>Add health information to family members to see it here!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            membersWithHealth.forEach(member => {
                const displayName = getDisplayName(member);
                
                html += `
                    <div class="person-entry">
                        <div class="person-first-line">
                            <div class="person-name-date">${displayName}</div>
                            <div class="person-buttons">
                                <button class="small-btn" onclick="editMember('${member.id}')">‚úèÔ∏è</button>
                            </div>
                        </div>
                        <div class="health-info">
                            <div class="health-title">üè• Health Information</div>
                            <div>${member.health_info}</div>
                        </div>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // Update birthday calendar
        function updateBirthdayCalendarView() {
            const list = document.getElementById('birthday-calendar-list');
            
            if (familyMembers.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üéÇ</div>
                        <p style="font-size: 20px;">No birthdays recorded yet</p>
                        <p>Add family members with birthdays to see the calendar!</p>
                    </div>
                `;
                return;
            }

            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const birthdaysByMonth = {};
            monthNames.forEach(month => birthdaysByMonth[month] = []);

            familyMembers
                .filter(member => member.birthday)
                .forEach(member => {
                    const birthDate = getDateForSorting(member.birthday);
                    const monthName = monthNames[birthDate.getMonth()];
                    const age = calculateAge(member.birthday, member.date_of_death);
                    const displayName = getSimpleDisplayName(member);
                    const formattedDate = formatDateDisplay(member.birthday);
                    
                    let birthdayText = `${displayName} - ${formattedDate}`;
                    if (member.date_of_death) {
                        const deathDate = formatDateDisplay(member.date_of_death);
                        birthdayText += `, died ${deathDate} - would be ${age}`;
                    } else {
                        birthdayText += ` - Age ${age}`;
                    }
                    
                    birthdaysByMonth[monthName].push({
                        date: member.birthday,
                        text: birthdayText,
                        sortDate: birthDate.getDate()
                    });
                });

            Object.keys(birthdaysByMonth).forEach(month => {
                birthdaysByMonth[month].sort((a, b) => a.sortDate - b.sortDate);
            });

            let html = '';
            monthNames.forEach(month => {
                const birthdays = birthdaysByMonth[month];
                if (birthdays.length > 0) {
                    html += `<div class="month-header">${month}</div>`;
                    
                    birthdays.forEach(birthday => {
                        html += `
                            <div class="calendar-item">
                                ${birthday.text}
                            </div>
                        `;
                    });
                }
            });

            if (html === '') {
                html = `
                    <div class="empty-state">
                        <div class="empty-icon">üéÇ</div>
                        <p style="font-size: 20px;">No birthdays recorded yet</p>
                        <p>Add family members with birthdays to see the calendar!</p>
                    </div>
                `;
            }

            list.innerHTML = html;
        }

        // Update anniversary calendar
        function updateAnniversaryCalendarView() {
            const list = document.getElementById('anniversary-calendar-list');
            
            const anniversaries = familyMembers.filter(member => member.anniversary);
            
            if (anniversaries.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üíç</div>
                        <p style="font-size: 20px;">No anniversaries recorded yet</p>
                        <p>Add anniversary dates to see the calendar!</p>
                    </div>
                `;
                return;
            }

            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const anniversariesByMonth = {};
            monthNames.forEach(month => anniversariesByMonth[month] = []);

            const processedCouples = new Set();

            anniversaries.forEach(member => {
                if (processedCouples.has(member.id)) return;

                const anniversaryDate = getDateForSorting(member.anniversary);
                const monthName = monthNames[anniversaryDate.getMonth()];
                
                const years = new Date().getFullYear() - anniversaryDate.getFullYear();
                
                const parts = member.anniversary.split('-');
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                const year = parts[0];
                const dateFormatted = `${month}/${day}/${year}`;
                
                const spouse = findSpouse(member);
                
                if (spouse) {
                    const name1 = getSimpleDisplayName(member);
                    const name2 = getSimpleDisplayName(spouse);
                    
                    anniversariesByMonth[monthName].push({
                        text: `${dateFormatted} ${name1} & ${name2} - ${years} yrs`,
                        sortDate: anniversaryDate.getDate()
                    });
                    
                    processedCouples.add(member.id);
                    processedCouples.add(spouse.id);
                } else {
                    const displayName = getSimpleDisplayName(member);
                    
                    anniversariesByMonth[monthName].push({
                        text: `${dateFormatted} ${displayName} - ${years} yrs`,
                        sortDate: anniversaryDate.getDate()
                    });
                    
                    processedCouples.add(member.id);
                }
            });

            Object.keys(anniversariesByMonth).forEach(month => {
                anniversariesByMonth[month].sort((a, b) => a.sortDate - b.sortDate);
            });

            let html = '';
            monthNames.forEach(month => {
                const monthAnniversaries = anniversariesByMonth[month];
                if (monthAnniversaries.length > 0) {
                    html += `<div class="month-header">${month}</div>`;
                    
                    monthAnniversaries.forEach(anniversary => {
                        html += `
                            <div class="calendar-item">
                                ${anniversary.text}
                            </div>
                        `;
                    });
                }
            });

            list.innerHTML = html;
        }

        // Update addresses view
        function updateAddressesView() {
            const list = document.getElementById('addresses-list');
            const addressMap = new Map();
            
            const livingMembers = familyMembers.filter(member => !member.date_of_death);
            
            livingMembers
                .filter(member => member.address && member.address.trim())
                .forEach(member => {
                    const address = member.address.trim();
                    if (!addressMap.has(address)) {
                        addressMap.set(address, []);
                    }
                    addressMap.get(address).push(member);
                });
            
            livingMembers
                .filter(member => member.parent_id && (!member.address || !member.address.trim()))
                .forEach(child => {
                    const parent = familyMembers.find(p => p.id === child.parent_id);
                    if (parent && parent.address && parent.address.trim()) {
                        const address = parent.address.trim();
                        if (addressMap.has(address)) {
                            if (!addressMap.get(address).some(m => m.id === child.id)) {
                                addressMap.get(address).push(child);
                            }
                        }
                    }
                });
            
            const addresses = Array.from(addressMap.entries());

            if (addresses.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üè†</div>
                        <p style="font-size: 20px;">No addresses recorded yet</p>
                        <p>Add addresses to family members to see them here!</p>
                    </div>
                `;
                return;
            }

            let addressEntries = [];
            addresses.forEach(([address, members]) => {
                const processedIds = new Set();
                let displayNames = [];
                
                members.forEach(member => {
                    if (processedIds.has(member.id)) return;
                    
                    const spouse = findSpouse(member);
                    
                    if (spouse && members.some(m => m.id == spouse.id)) {
                        const lastName = member.full_name.split(' ').pop();
                        const firstName1 = member.preferred_name || member.full_name.split(' ')[0];
                        const firstName2 = spouse.preferred_name || spouse.full_name.split(' ')[0];
                        displayNames.push(`${lastName}, ${firstName1} & ${firstName2}`);
                        processedIds.add(member.id);
                        processedIds.add(spouse.id);
                    } else if (!processedIds.has(member.id)) {
                        const lastName = member.full_name.split(' ').pop();
                        const firstName = member.preferred_name || member.full_name.split(' ')[0];
                        displayNames.push(`${lastName}, ${firstName}`);
                        processedIds.add(member.id);
                    }
                });
                
                const names = displayNames.join(', ');
                const sortKey = displayNames[0] ? displayNames[0].split(',')[0] : 'Unknown';
                addressEntries.push({ names, address, sortKey });
            });

            addressEntries.sort((a, b) => a.sortKey.localeCompare(b.sortKey));

            let html = '';
            addressEntries.forEach(entry => {
                html += `<div class="address-item">${entry.names} ${entry.address}</div>`;
            });

            list.innerHTML = html;
        }

        // Update phone list view
        function updatePhoneListView() {
            const list = document.getElementById('phone-directory-list');
            
            const membersWithPhones = familyMembers.filter(member => 
                member.phone && member.phone.trim()
            );
            
            if (membersWithPhones.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìû</div>
                        <p style="font-size: 20px;">No phone numbers recorded yet</p>
                        <p>Add phone numbers to family members to see the directory!</p>
                    </div>
                `;
                return;
            }

            membersWithPhones.sort((a, b) => {
                const nameA = getSimpleDisplayName(a).toLowerCase();
                const nameB = getSimpleDisplayName(b).toLowerCase();
                return nameA.localeCompare(nameB);
            });

            let html = '';
            membersWithPhones.forEach(member => {
                const displayName = getSimpleDisplayName(member);
                html += `
                    <div class="phone-item">
                        <span class="phone-name">${displayName}</span>
                        <span>${member.phone}</span>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // Auto-format phone as user types
        document.addEventListener('DOMContentLoaded', function() {
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    e.target.value = formatPhoneNumber(e.target.value);
                });
            }
        });

        // Make sure functions are available globally
        window.showCreateForm = showCreateForm;
        window.showJoinForm = showJoinForm;
        window.hideStartupForms = hideStartupForms;
        window.createDirectory = createDirectory;
        window.joinDirectory = joinDirectory;
        window.leaveDirectory = leaveDirectory;
        window.showInviteCode = showInviteCode;
        window.copyInviteCode = copyInviteCode;
        window.closeInviteModal = closeInviteModal;
        window.showTab = showTab;
        window.clearForm = clearForm;
        window.addOrUpdateMember = addOrUpdateMember;
        window.editMember = editMember;
        window.deleteMember = deleteMember;

        console.log('All functions loaded successfully');
    </script>
</body>
</html>
