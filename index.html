window.exportToWord = exportToWord;
        window.exportAll = exportAll;<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Directory</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196f3 0%, #9c27b0 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .family-name-setup {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .family-name-setup button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .startup-screen {
            padding: 40px;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .startup-option {
            background: white;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .startup-option:hover {
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .startup-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 100%;
            font-size: 16px;
        }

        .startup-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            padding: 10px;
        }

        .tab {
            background: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            background: #2196f3;
            color: white;
        }

        .controls {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .content {
            padding: 30px;
        }

        .form-section {
            max-width: 800px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        label.optional {
            color: #666;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: Arial, sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2196f3;
        }

        textarea {
            resize: vertical;
            height: 60px;
        }

        .big-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            margin-right: 15px;
        }

        .big-btn.gray {
            background: #757575;
        }

        .family-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .family-list .person-entry {
            margin-bottom: 12px !important;
            padding: 6px !important;
            border-radius: 6px;
            background: #fafafa;
        }

        .family-list .person-first-line {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            line-height: 1.1 !important;
            margin-bottom: 2px !important;
        }

        .small-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 1px 4px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 8px;
            font-weight: 600;
            pointer-events: auto;
            z-index: 999;
            position: relative;
        }

        .small-btn.red {
            background: #f44336;
        }

        .family-list .person-details {
            font-size: 14px;
            color: #666;
            margin-top: 1px !important;
            line-height: 1.1 !important;
        }

        .family-list .health-info {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 6px;
            padding: 6px !important;
            margin-top: 2px !important;
            font-size: 12px;
            line-height: 1.1 !important;
        }

        .health-title {
            color: #c62828;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .address-item {
            margin-bottom: 1px;
            padding: 6px;
            background: #f9f9f9;
            border-radius: 4px;
            line-height: 1.2;
        }

        .calendar-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }

        .month-header {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        .month-header:first-child {
            margin-top: 0;
        }

        .calendar-item {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            line-height: 1.4;
        }

        .calendar-item:last-child {
            border-bottom: none;
        }

        .phone-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }

        .phone-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .phone-item:last-child {
            border-bottom: none;
        }

        .phone-name {
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin: 2px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Startup Screen -->
        <div id="startup-screen" class="startup-screen">
            <h1 style="color: #2196f3; margin-bottom: 30px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Directory</h1>
            <p style="color: #666; margin-bottom: 20px;">üß™ <strong>TESTING VERSION</strong> - Data stored temporarily for testing interface changes</p>
            
            <div class="startup-option" onclick="showCreateForm()">
                <h3>üÜï Create New Family Directory</h3>
                <p>Start a new family directory and invite family members</p>
            </div>
            
            <div class="startup-option" onclick="showJoinForm()">
                <h3>üîó Join Existing Directory</h3>
                <p>Enter an invite code to join a family directory</p>
            </div>

            <!-- Create Form -->
            <div id="create-form" style="display: none; margin-top: 30px;">
                <h3>Create New Directory</h3>
                <input type="text" id="new-family-name" class="startup-input" placeholder="Enter family name (e.g., Smith Family)">
                <button class="startup-button" onclick="createDirectory()">Create Directory</button>
                <button class="startup-button" style="background: #757575;" onclick="hideStartupForms()">Cancel</button>
            </div>

            <!-- Join Form -->
            <div id="join-form" style="display: none; margin-top: 30px;">
                <h3>Join Directory</h3>
                <input type="text" id="invite-code" class="startup-input" placeholder="Enter invite code (e.g., SMITH2024)">
                <button class="startup-button" onclick="joinDirectory()">Join Directory</button>
                <button class="startup-button" style="background: #757575;" onclick="hideStartupForms()">Cancel</button>
            </div>
        </div>

        <!-- Main App (hidden initially) -->
        <div id="main-app" style="display: none;">
            <!-- Header -->
            <div class="header">
                <div class="family-name-setup">
                    <button onclick="leaveDirectory()" style="background: rgba(255,0,0,0.3);">Leave Directory</button>
                    <button onclick="showInviteCode()" style="background: rgba(0,255,0,0.3);">Share Code</button>
                </div>
                <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ <span id="directory-title">Family Directory</span></h1>
                <p>üß™ Testing interface changes - data stored temporarily</p>
                <p style="font-size: 14px; margin-top: 5px;">Invite Code: <strong id="current-invite-code"></strong></p>
            </div>

            <!-- Navigation Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('directory')">üìã Family Directory</button>
                <button class="tab" onclick="showTab('add')">‚ûï Add/Edit Person</button>
                <button class="tab" onclick="showTab('birthday-calendar')">üéÇ Birthday Calendar</button>
                <button class="tab" onclick="showTab('anniversary-calendar')">üíç Anniversary Calendar</button>
                <button class="tab" onclick="showTab('addresses')">üè† Addresses</button>
                <button class="tab" onclick="showTab('health')">üè• Health Information</button>
                <button class="tab" onclick="showTab('phone-list')">üìû Phone List</button>
                <button class="tab" onclick="exportToWord()">üìÑ Export Word Doc</button>
            </div>

            <!-- Controls -->
            <div class="controls">
                <span style="color: #666; font-size: 14px;">
                    ‚ö†Ô∏è Download this HTML file to test Supabase features locally
                </span>
            </div>

            <!-- Main Content -->
            <div class="content">
                
                <!-- Add/Edit Tab -->
                <div id="add-tab" class="tab-content" style="display: none;">
                    <h2 id="form-title">‚ûï Add New Family Member</h2>
                    <br>
                    
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label>üë§ Full Name *</label>
                                <input type="text" id="fullName">
                            </div>
                            <div class="form-group">
                                <label class="optional">‚ú® Preferred Name</label>
                                <input type="text" id="preferredName" placeholder="What they like to be called">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üí∞ Maiden Name (if applicable)</label>
                                <input type="text" id="maidenName">
                            </div>
                            <div class="form-group">
                                <label>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parents - Select all that apply</label>
                                <div id="parents-selection" style="margin-bottom: 10px; max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
                                    <!-- Parent checkboxes will be populated here -->
                                </div>
                                <label class="optional" style="margin-top: 10px;">Other parent not listed:</label>
                                <input type="text" id="otherParent" placeholder="Enter parent's name (e.g., John Smith)">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üíï Spouse (if married)</label>
                                <select id="spouseId">
                                    <option value="">Select spouse (or leave blank if single)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>üéÇ Birthday * (Required)</label>
                                <input type="text" id="birthday" required style="border-color: #f44336;" 
                                       placeholder="MM-DD-YYYY (e.g., 03-15-1965)" 
                                       maxlength="10">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üíç Anniversary (if married)</label>
                                <input type="text" id="anniversary" placeholder="MM-DD-YYYY (e.g., 06-12-1990)" 
                                       maxlength="10">
                            </div>
                            <div class="form-group">
                                <label class="optional">‚ö∞Ô∏è Date of Death (if deceased)</label>
                                <input type="text" id="dateOfDeath" placeholder="MM-DD-YYYY (e.g., 12-25-2020)" 
                                       maxlength="10">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üì± Phone Number</label>
                                <input type="tel" id="phone" placeholder="555-123-4567">
                            </div>
                            <div class="form-group">
                                <label class="optional">‚úâÔ∏è Email</label>
                                <input type="email" id="email">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="optional">üì∑ Instagram Handle</label>
                                <input type="text" id="instagram" placeholder="@username">
                            </div>
                            <div class="form-group">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="optional">üè† Address</label>
                            <textarea id="address"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="optional">üè• Health Issues - Anything you think sharing would be useful information for others</label>
                            <textarea id="healthInfo"></textarea>
                        </div>

                        <div style="margin-top: 30px;">
                            <button class="big-btn" onclick="addOrUpdateMember()" id="submit-btn">‚ûï Add to Family</button>
                            <button class="big-btn gray" onclick="clearForm()">üîÑ Clear Form</button>
                        </div>
                    </div>
                </div>

                <!-- Directory Tab -->
                <div id="directory-tab" class="tab-content">
                    <h2>üìã Family Members (<span id="member-count">0</span>)</h2>
                    <button class="big-btn" onclick="exportAll()" style="margin-bottom: 20px;">üìÑ Export All</button>
                    <br>
                    <div class="family-list" id="family-list"></div>
                </div>

                <!-- Health Information Tab -->
                <div id="health-tab" class="tab-content" style="display: none;">
                    <h2>üè• Health Information</h2>
                    <button class="big-btn" onclick="exportHealthInfo()" style="margin-bottom: 20px;">üìÑ Export Health Information</button>
                    <br>
                    <div id="health-list"></div>
                </div>

                <!-- Birthday Calendar Tab -->
                <div id="birthday-calendar-tab" class="tab-content" style="display: none;">
                    <h2>üéÇ Birthday Calendar</h2>
                    <p style="color: #666; margin-bottom: 20px;">All family birthdays organized by month</p>
                    <button class="big-btn" onclick="exportBirthdays()" style="margin-bottom: 20px;">üìÑ Export Birthday Calendar</button>
                    <div class="calendar-list" id="birthday-calendar-list"></div>
                </div>

                <!-- Anniversary Calendar Tab -->
                <div id="anniversary-calendar-tab" class="tab-content" style="display: none;">
                    <h2>üíç Anniversary Calendar</h2>
                    <p style="color: #666; margin-bottom: 20px;">All family anniversaries organized by month</p>
                    <button class="big-btn" onclick="exportAnniversaries()" style="margin-bottom: 20px;">üìÑ Export Anniversary Calendar</button>
                    <div class="calendar-list" id="anniversary-calendar-list"></div>
                </div>

                <!-- Addresses Tab -->
                <div id="addresses-tab" class="tab-content" style="display: none;">
                    <h2>üè† Family Addresses</h2>
                    <button class="big-btn" onclick="exportAddresses()" style="margin-bottom: 20px;">üìÑ Export Address Directory</button>
                    <br>
                    <div id="addresses-list"></div>
                </div>

                <!-- Phone List Tab -->
                <div id="phone-list-tab" class="tab-content" style="display: none;">
                    <h2>üìû Phone Directory</h2>
                    <p style="color: #666; margin-bottom: 20px;">All family members alphabetically by first name with phone numbers</p>
                    <button class="big-btn" onclick="exportPhoneList()" style="margin-bottom: 20px;">üìÑ Export Phone Directory</button>
                    <div class="phone-list" id="phone-directory-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ydsgjlsbbwsxzjewktbk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlkc2dqbHNiYndzeHpqZXdrdGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTc1OTEsImV4cCI6MjA2OTU5MzU5MX0.WfvHuhKdieJbLocKbv2oosBKzKl1dsZu50mA9OUHRtA';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let familyMembers = [];
        let editingId = null;
        let currentDirectoryId = null;
        let currentDirectoryName = '';
        let currentInviteCode = '';
        let isSubmitting = false;

        // Startup functions
        function showCreateForm() {
            document.getElementById('create-form').style.display = 'block';
            document.getElementById('join-form').style.display = 'none';
        }

        function showJoinForm() {
            document.getElementById('join-form').style.display = 'block';
            document.getElementById('create-form').style.display = 'none';
        }

        function hideStartupForms() {
            document.getElementById('create-form').style.display = 'none';
            document.getElementById('join-form').style.display = 'none';
        }

        async function createDirectory() {
            const familyName = document.getElementById('new-family-name').value.trim();
            if (!familyName) {
                alert('Please enter a family name');
                return;
            }

            try {
                // Generate invite code
                const inviteCode = familyName.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 8) + 
                                 Math.floor(Math.random() * 1000);

                console.log('Creating directory with name:', familyName + ' Directory');
                console.log('Creating directory with invite_code:', inviteCode);

                // Create directory in Supabase
                const { data, error } = await supabase
                    .from('family_directories')
                    .insert([{
                        name: familyName + ' Directory',
                        invite_code: inviteCode
                    }])
                    .select()
                    .single();

                console.log('Supabase data:', JSON.stringify(data, null, 2));
                console.log('Supabase error:', JSON.stringify(error, null, 2));

                if (error) {
                    console.error('Error details:', error.message, error.details, error.hint, error.code);
                    alert(`Error creating directory: ${error.message}`);
                    return;
                }

                console.log('Directory created successfully with ID:', data.id);

                // Join the directory
                await joinDirectoryById(data.id, data.name, data.invite_code);
                
                // Show the invite code
                setTimeout(() => {
                    showInviteCode();
                }, 500);
            } catch (err) {
                console.error('Catch block error:', err.message);
                alert(`Error creating directory: ${err.message}`);
            }
        }

        async function joinDirectory() {
            const inviteCode = document.getElementById('invite-code').value.trim().toUpperCase();
            if (!inviteCode) {
                alert('Please enter an invite code');
                return;
            }

            try {
                // Find directory by invite code
                const { data, error } = await supabase
                    .from('family_directories')
                    .select('*')
                    .eq('invite_code', inviteCode)
                    .single();

                if (error || !data) {
                    alert('Invalid invite code. Please check and try again.');
                    return;
                }

                // Join the directory
                await joinDirectoryById(data.id, data.name, data.invite_code);
                alert('‚úÖ Successfully joined family directory!');
            } catch (err) {
                console.error('Error:', err);
                alert('Error joining directory. Please try again.');
            }
        }

        async function joinDirectoryById(directoryId, directoryName, inviteCode) {
            currentDirectoryId = directoryId;
            currentDirectoryName = directoryName;
            currentInviteCode = inviteCode;

            // Save to localStorage so it persists across browser sessions
            localStorage.setItem('currentDirectoryId', directoryId);
            localStorage.setItem('currentDirectoryName', directoryName);
            localStorage.setItem('currentInviteCode', inviteCode);

            // Update UI
            document.getElementById('directory-title').textContent = directoryName;
            document.getElementById('current-invite-code').textContent = inviteCode;
            document.getElementById('startup-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            // Load data from Supabase
            await loadData();
            updateDropdowns();
            updateAllViews();
        }

        function leaveDirectory() {
            if (confirm('Are you sure you want to leave this family directory?')) {
                currentDirectoryId = null;
                currentDirectoryName = '';
                currentInviteCode = '';
                familyMembers = [];
                
                // Clear localStorage
                localStorage.removeItem('currentDirectoryId');
                localStorage.removeItem('currentDirectoryName');
                localStorage.removeItem('currentInviteCode');
                
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('startup-screen').style.display = 'block';
                hideStartupForms();
            }
        }

        // Initialize app when page loads
        window.addEventListener('load', async function() {
            await initializeApp();
        });

        function leaveDirectory() {
            if (confirm('Are you sure you want to leave this family directory?')) {
                currentDirectoryId = null;
                currentDirectoryName = '';
                currentInviteCode = '';
                familyMembers = [];
                
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('startup-screen').style.display = 'block';
                hideStartupForms();
            }
        }

        function showInviteCode() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 15px;
                text-align: center;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h2 style="color: #2196f3; margin-bottom: 20px;">üì§ Share Your Family Directory</h2>
                <p style="margin-bottom: 20px; font-size: 16px;">Share this invite code with family members:</p>
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #2196f3;">
                    <h1 style="color: #1976d2; font-size: 2.5rem; letter-spacing: 3px; margin: 0;">${currentInviteCode}</h1>
                </div>
                <p style="margin: 20px 0; color: #666; font-size: 14px;">
                    üß™ <strong>Testing version only</strong> - Family members can test by entering this code.
                </p>
                <button onclick="copyInviteCode()" style="
                    background: #4caf50; 
                    color: white; 
                    border: none; 
                    padding: 15px 30px; 
                    border-radius: 8px; 
                    font-size: 16px; 
                    margin: 10px; 
                    cursor: pointer;
                ">üìã Copy Code</button>
                <button onclick="closeInviteModal()" style="
                    background: #757575; 
                    color: white; 
                    border: none; 
                    padding: 15px 30px; 
                    border-radius: 8px; 
                    font-size: 16px; 
                    margin: 10px; 
                    cursor: pointer;
                ">‚ùå Close</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            modal.id = 'invite-modal';
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeInviteModal();
                }
            });
        }

        function copyInviteCode() {
            navigator.clipboard.writeText(currentInviteCode).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.style.background = '#4caf50';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#4caf50';
                }, 2000);
            }).catch(() => {
                alert('Code copied to clipboard!');
            });
        }

        function closeInviteModal() {
            const modal = document.getElementById('invite-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Load data from Supabase
        async function loadData() {
            if (!currentDirectoryId) return;
            
            try {
                const { data, error } = await supabase
                    .from('family_members')
                    .select('*')
                    .eq('directory_id', currentDirectoryId);

                if (error) {
                    console.error('Error loading data:', error);
                    return;
                }

                // Convert Supabase data to our format
                familyMembers = (data || []).map(member => ({
                    id: member.id,
                    full_name: member.full_name,
                    preferred_name: member.preferred_name,
                    maiden_name: member.maiden_name,
                    parent_ids: member.parent_ids || (member.parent_id ? [member.parent_id] : null),
                    other_parent: member.other_parent,
                    spouse_id: member.spouse_id,
                    birthday: member.birthday,
                    anniversary: member.anniversary,
                    date_of_death: member.date_of_death,
                    phone: member.phone,
                    email: member.email,
                    instagram: member.instagram,
                    address: member.address,
                    health_info: member.health_info
                }));
                
                console.log('Loaded family members:', familyMembers.length);
            } catch (err) {
                console.error('Error:', err);
                familyMembers = [];
            }
        }

        // Save data to Supabase
        async function saveData() {
            // This function is now handled by individual member save/update
        }

        // Initialize app - load any saved directory ID
        async function initializeApp() {
            const savedDirectoryId = localStorage.getItem('currentDirectoryId');
            const savedDirectoryName = localStorage.getItem('currentDirectoryName');
            const savedInviteCode = localStorage.getItem('currentInviteCode');
            
            if (savedDirectoryId && savedDirectoryName && savedInviteCode) {
                await joinDirectoryById(savedDirectoryId, savedDirectoryName, savedInviteCode);
            }
        }

        // Helper function to find someone's spouse
        function findSpouse(person) {
            if (!person || !person.spouse_id) return null;
            return familyMembers.find(member => member.id == person.spouse_id);
        }

        // Format phone number with dashes
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 10) {
                return digits.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            }
            return phone;
        }

        // Auto-format dates as user types
        function formatDateInput(input) {
            let value = input.value.replace(/\D/g, '');
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '-' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 9);
            }
            
            input.value = value;
        }

        // Convert MM-DD-YYYY to YYYY-MM-DD for database
        function convertDateForDB(dateString) {
            if (!dateString || !dateString.includes('-')) return dateString;
            
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const [month, day, year] = parts;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            return dateString;
        }

        // Convert YYYY-MM-DD to MM-DD-YYYY for display
        function convertDateForDisplay(dateString) {
            if (!dateString || !dateString.includes('-')) return dateString;
            
            const parts = dateString.split('-');
            if (parts.length === 3 && parts[0].length === 4) {
                const [year, month, day] = parts;
                return `${month}-${day}-${year}`;
            }
            return dateString;
        }

        // Fix date display to prevent day shifting
        function formatDateDisplay(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            const date = new Date(year, month, day);
            return date.toLocaleDateString();
        }

        // Fix date for calendar sorting
        function getDateForSorting(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            return new Date(year, month, day);
        }

        // Update parent and spouse dropdowns
        function updateDropdowns() {
            updateParentDropdown();
            updateSpouseDropdown();
        }

        // Update parent selection area with checkboxes
        function updateParentDropdown() {
            const container = document.getElementById('parents-selection');
            
            const potentialParents = familyMembers.filter(member => {
                if (member.id === editingId) return false;
                if (!member.birthday) return true;
                const age = calculateAge(member.birthday);
                return age >= 15;
            });
            
            if (potentialParents.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No potential parents in directory yet</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; line-height: 1;">';
            const processedIds = new Set();
            const directoryLastName = currentDirectoryName.replace(' Directory', '');
            
            // Sort parents to prioritize directory family name and maiden names
            const sortedParents = [...potentialParents].sort((a, b) => {
                const aHasDirectoryName = a.full_name.includes(directoryLastName) || a.maiden_name === directoryLastName;
                const bHasDirectoryName = b.full_name.includes(directoryLastName) || b.maiden_name === directoryLastName;
                
                if (aHasDirectoryName && !bHasDirectoryName) return -1;
                if (!aHasDirectoryName && bHasDirectoryName) return 1;
                return a.full_name.localeCompare(b.full_name);
            });
            
            sortedParents.forEach(parent => {
                if (processedIds.has(parent.id)) return;
                
                const spouse = findSpouse(parent);
                
                if (spouse && potentialParents.some(p => p.id == spouse.id)) {
                    // Determine which spouse should be listed first (directory name/maiden name priority)
                    let firstSpouse = parent;
                    let secondSpouse = spouse;
                    
                    const parentHasDirectoryName = parent.full_name.includes(directoryLastName) || parent.maiden_name === directoryLastName;
                    const spouseHasDirectoryName = spouse.full_name.includes(directoryLastName) || spouse.maiden_name === directoryLastName;
                    
                    if (spouseHasDirectoryName && !parentHasDirectoryName) {
                        firstSpouse = spouse;
                        secondSpouse = parent;
                    }
                    
                    html += `
                        <label style="display: flex; justify-content: space-between; align-items: center; font-weight: normal; cursor: pointer; padding: 1px 0; line-height: 1;">
                            <span style="line-height: 1;">${firstSpouse.full_name}</span>
                            <input type="checkbox" value="${firstSpouse.id}" class="parent-checkbox">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; font-weight: normal; cursor: pointer; padding: 1px 0; line-height: 1;">
                            <span style="line-height: 1;">${secondSpouse.full_name}</span>
                            <input type="checkbox" value="${secondSpouse.id}" class="parent-checkbox">
                        </label>
                    `;
                    processedIds.add(parent.id);
                    processedIds.add(spouse.id);
                } else {
                    // Show single person
                    html += `
                        <label style="display: flex; justify-content: space-between; align-items: center; font-weight: normal; cursor: pointer; padding: 1px 0; line-height: 1;">
                            <span style="line-height: 1;">${parent.full_name}</span>
                            <input type="checkbox" value="${parent.id}" class="parent-checkbox">
                        </label>
                    `;
                    processedIds.add(parent.id);
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Update spouse dropdown
        function updateSpouseDropdown() {
            const select = document.getElementById('spouseId');
            const currentValue = select.value;
            
            let options = '<option value="">Select spouse (or leave blank if single)</option>';
            familyMembers.forEach(member => {
                if (member.id !== editingId) {
                    options += `<option value="${member.id}">${getDisplayNameWithLastName(member)}</option>`;
                }
            });
            
            select.innerHTML = options;
            select.value = currentValue;
        }

        // Get display name with last name for dropdowns
        function getDisplayNameWithLastName(member) {
            const fullNameParts = member.full_name.trim().split(' ');
            const lastName = fullNameParts[fullNameParts.length - 1];
            
            if (member.preferred_name && member.preferred_name.trim()) {
                return `${member.preferred_name.trim()} ${lastName}`;
            } else {
                return member.full_name;
            }
        }

        // Get simple display name for most views
        function getSimpleDisplayName(member) {
            const fullNameParts = member.full_name.trim().split(' ');
            const lastName = fullNameParts[fullNameParts.length - 1];
            
            if (member.preferred_name && member.preferred_name.trim()) {
                return `${member.preferred_name.trim()} ${lastName}`;
            } else {
                return member.full_name;
            }
        }

        // Show tab
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.style.display = 'none');
            
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            const clickedButton = Array.from(tabButtons).find(btn => 
                btn.textContent.includes(getTabDisplayName(tabName))
            );
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            if (tabName === 'add' && !editingId) {
                clearForm();
            }
        }

        // Helper function to get tab display name
        function getTabDisplayName(tabName) {
            const tabNames = {
                'directory': 'Family Directory',
                'add': 'Add/Edit Person',
                'birthday-calendar': 'Birthday Calendar',
                'anniversary-calendar': 'Anniversary Calendar',
                'addresses': 'Addresses',
                'health': 'Health Information',
                'phone-list': 'Phone List'
            };
            return tabNames[tabName] || tabName;
        }

        // Clear form
        function clearForm() {
            document.getElementById('fullName').value = '';
            document.getElementById('preferredName').value = '';
            document.getElementById('maidenName').value = '';
            
            // Clear parent checkboxes
            const checkboxes = document.querySelectorAll('.parent-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('otherParent').value = '';
            
            document.getElementById('spouseId').value = '';
            document.getElementById('birthday').value = '';
            document.getElementById('anniversary').value = '';
            document.getElementById('dateOfDeath').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('email').value = '';
            document.getElementById('instagram').value = '';
            document.getElementById('address').value = '';
            document.getElementById('healthInfo').value = '';
            
            editingId = null;
            document.getElementById('form-title').textContent = '‚ûï Add New Family Member';
            document.getElementById('submit-btn').textContent = '‚ûï Add to Family';
            
            updateDropdowns();
        }

        // Add or update member with Supabase
        function addOrUpdateMember() {
            if (isSubmitting) return;
            isSubmitting = true;
            
            const fullName = document.getElementById('fullName').value.trim();
            const birthdayInput = document.getElementById('birthday').value.trim();

            if (!fullName || !birthdayInput) {
                alert('Please fill in:\n‚Ä¢ Full Name\n‚Ä¢ Birthday\n\nThese are required fields.');
                isSubmitting = false;
                return;
            }

            // Validate date format
            const dateRegex = /^\d{2}-\d{2}-\d{4}$/;
            if (!dateRegex.test(birthdayInput)) {
                alert('Please enter birthday in MM-DD-YYYY format (e.g., 03-15-1965)');
                isSubmitting = false;
                return;
            }

            const anniversary = document.getElementById('anniversary').value.trim();
            const dateOfDeath = document.getElementById('dateOfDeath').value.trim();
            
            // Convert dates to database format (YYYY-MM-DD)
            const birthday = convertDateForDB(birthdayInput);
            const anniversaryDB = anniversary ? convertDateForDB(anniversary) : null;
            const dateOfDeathDB = dateOfDeath ? convertDateForDB(dateOfDeath) : null;

            // Get selected parents
            const selectedParents = [];
            const checkboxes = document.querySelectorAll('.parent-checkbox:checked');
            checkboxes.forEach(cb => selectedParents.push(cb.value));
            
            const otherParent = document.getElementById('otherParent').value.trim();

            const memberData = {
                directory_id: currentDirectoryId,
                full_name: fullName,
                preferred_name: document.getElementById('preferredName').value.trim() || null,
                maiden_name: document.getElementById('maidenName').value.trim() || null,
                parent_ids: selectedParents.length > 0 ? selectedParents : null,
                other_parent: otherParent || null,
                spouse_id: document.getElementById('spouseId').value || null,
                birthday: birthday,
                anniversary: anniversaryDB,
                date_of_death: dateOfDeathDB,
                phone: formatPhoneNumber(document.getElementById('phone').value.trim()) || null,
                email: document.getElementById('email').value.trim() || null,
                instagram: document.getElementById('instagram').value.trim() || null,
                address: document.getElementById('address').value.trim() || null,
                health_info: document.getElementById('healthInfo').value.trim() || null
            };

            if (editingId) {
                updateMemberInSupabase(memberData);
            } else {
                addMemberToSupabase(memberData);
            }
        }

        // Add member to Supabase
        async function addMemberToSupabase(memberData) {
            try {
                const { data, error } = await supabase
                    .from('family_members')
                    .insert([memberData])
                    .select()
                    .single();

                if (error) {
                    console.error('Error adding member:', error);
                    alert('Error adding family member. Please try again.');
                    isSubmitting = false;
                    return;
                }

                // Auto-sync spouse data
                if (memberData.spouse_id) {
                    await syncSpouseData(data.id, memberData.spouse_id, memberData.anniversary);
                }

                alert('‚úÖ Family member added successfully!');
                await refreshData();
                clearForm();
            } catch (err) {
                console.error('Error:', err);
                alert('Error adding family member. Please try again.');
            }
            isSubmitting = false;
        }

        // Update member in Supabase
        async function updateMemberInSupabase(memberData) {
            try {
                const { error } = await supabase
                    .from('family_members')
                    .update(memberData)
                    .eq('id', editingId);

                if (error) {
                    console.error('Error updating member:', error);
                    alert('Error updating family member. Please try again.');
                    isSubmitting = false;
                    return;
                }

                // Auto-sync spouse data
                if (memberData.spouse_id) {
                    await syncSpouseData(editingId, memberData.spouse_id, memberData.anniversary);
                }

                alert('‚úÖ Family member updated successfully!');
                await refreshData();
                clearForm();
            } catch (err) {
                console.error('Error:', err);
                alert('Error updating family member. Please try again.');
            }
            isSubmitting = false;
        }

        // Sync spouse data
        async function syncSpouseData(memberId, spouseId, anniversary) {
            try {
                const updateData = { spouse_id: memberId };
                if (anniversary) {
                    updateData.anniversary = anniversary;
                }

                await supabase
                    .from('family_members')
                    .update(updateData)
                    .eq('id', spouseId);
            } catch (err) {
                console.error('Error syncing spouse data:', err);
            }
        }

        // Refresh data from Supabase
        async function refreshData() {
            await loadData();
            updateDropdowns();
            updateAllViews();
        }

        // Edit member
        function editMember(id) {
            const member = familyMembers.find(m => m.id == id);
            if (!member) return;

            editingId = id;
            
            document.getElementById('fullName').value = member.full_name || '';
            document.getElementById('preferredName').value = member.preferred_name || '';
            document.getElementById('maidenName').value = member.maiden_name || '';
            
            // Handle parent selection (wait for dropdowns to update)
            setTimeout(() => {
                // Clear all checkboxes first
                const checkboxes = document.querySelectorAll('.parent-checkbox');
                checkboxes.forEach(cb => cb.checked = false);
                
                // Check the appropriate parent boxes
                if (member.parent_ids && Array.isArray(member.parent_ids)) {
                    member.parent_ids.forEach(parentId => {
                        const checkbox = document.querySelector(`.parent-checkbox[value="${parentId}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else if (member.parent_id) {
                    // Handle old single parent format
                    const checkbox = document.querySelector(`.parent-checkbox[value="${member.parent_id}"]`);
                    if (checkbox) checkbox.checked = true;
                }
                
                document.getElementById('otherParent').value = member.other_parent || '';
            }, 100);
            
            document.getElementById('spouseId').value = member.spouse_id || '';
            document.getElementById('birthday').value = convertDateForDisplay(member.birthday) || '';
            document.getElementById('anniversary').value = convertDateForDisplay(member.anniversary) || '';
            document.getElementById('dateOfDeath').value = convertDateForDisplay(member.date_of_death) || '';
            document.getElementById('phone').value = member.phone || '';
            document.getElementById('email').value = member.email || '';
            document.getElementById('instagram').value = member.instagram || '';
            document.getElementById('address').value = member.address || '';
            document.getElementById('healthInfo').value = member.health_info || '';
            
            const displayName = getSimpleDisplayName(member);
            document.getElementById('form-title').textContent = `‚úèÔ∏è Edit ${displayName}`;
            document.getElementById('submit-btn').textContent = 'üíæ Save Changes';
            
            updateDropdowns();
            showTab('add');
        }

        // Delete member from Supabase
        async function deleteMember(memberId) {
            if (!confirm('Are you sure you want to remove this family member?')) return;

            try {
                const { error } = await supabase
                    .from('family_members')
                    .delete()
                    .eq('id', memberId);

                if (error) {
                    console.error('Error deleting member:', error);
                    alert('Error removing family member. Please try again.');
                    return;
                }

                alert('‚úÖ Family member removed successfully!');
                await refreshData();
            } catch (err) {
                console.error('Error:', err);
                alert('Error removing family member. Please try again.');
            }
        }

        // Calculate age
        function calculateAge(birthday, dateOfDeath = null) {
            if (!birthday) return 'Unknown';
            const today = new Date();
            const birthDate = new Date(birthday);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Get display name with death indicator
        function getDisplayName(member) {
            let name = member.full_name;
            if (member.preferred_name && member.preferred_name !== member.full_name) {
                name += ` - ${member.preferred_name}`;
            }
            if (member.maiden_name) {
                name += ` (n√©e ${member.maiden_name})`;
            }
            return name;
        }

        // Update all views
        function updateAllViews() {
            updateDirectoryView();
            updateBirthdayCalendarView();
            updateAnniversaryCalendarView();
            updateAddressesView();
            updateHealthView();
            updatePhoneListView();
        }

        // Build family tree - PROPER FAMILY HIERARCHY WITH DIRECTORY PRIORITY
        function buildFamilyTree() {
            const directoryLastName = currentDirectoryName.replace(' Directory', '');
            const processedIds = new Set();
            const orderedFamilyList = [];

            // Step 1: Find directory family members who are top-level (no parents)
            const directoryTopLevel = familyMembers.filter(member => {
                const lastName = member.full_name.trim().split(' ').pop();
                const hasDirectoryName = lastName === directoryLastName || member.maiden_name === directoryLastName;
                const hasNoParents = !hasAnyParents(member);
                return hasDirectoryName && hasNoParents;
            });

            // Sort directory family by age (oldest first - older marriages first)
            directoryTopLevel.sort((a, b) => {
                if (!a.birthday && !b.birthday) return 0;
                if (!a.birthday) return 1;
                if (!b.birthday) return -1;
                return new Date(a.birthday) - new Date(b.birthday);
            });

            // Process directory family first
            directoryTopLevel.forEach(person => {
                if (processedIds.has(person.id)) return;

                // Add directory person
                orderedFamilyList.push(person);
                processedIds.add(person.id);

                // Add their spouse chain (includes remarriages)
                addSpouseChain(person, orderedFamilyList, processedIds);

                // Add all their descendants
                const addDescendants = (parentId) => {
                    const children = familyMembers.filter(m => isChildOf(m, parentId));
                    
                    // Sort children by age (older children first)
                    children.sort((a, b) => {
                        if (!a.birthday && !b.birthday) return 0;
                        if (!a.birthday) return 1;
                        if (!b.birthday) return -1;
                        return new Date(a.birthday) - new Date(b.birthday);
                    });

                    children.forEach(child => {
                        if (!processedIds.has(child.id)) {
                            // Add child
                            orderedFamilyList.push(child);
                            processedIds.add(child.id);

                            // Add child's spouse chain (includes remarriages)
                            addSpouseChain(child, orderedFamilyList, processedIds);

                            // Recursively add their children
                            addDescendants(child.id);
                        }
                    });
                };

                addDescendants(person.id);
            });

            // Step 2: Add other top-level families (non-directory names)
            const otherTopLevel = familyMembers.filter(member => {
                const lastName = member.full_name.trim().split(' ').pop();
                const hasDirectoryName = lastName === directoryLastName || member.maiden_name === directoryLastName;
                const hasNoParents = !hasAnyParents(member);
                const notProcessed = !processedIds.has(member.id);
                return !hasDirectoryName && hasNoParents && notProcessed;
            });

            // Sort other families by age (older marriages first)
            otherTopLevel.sort((a, b) => {
                if (!a.birthday && !b.birthday) return 0;
                if (!a.birthday) return 1;
                if (!b.birthday) return -1;
                return new Date(a.birthday) - new Date(b.birthday);
            });

            // Process other families - SAME LOGIC, always add spouse chains
            otherTopLevel.forEach(person => {
                if (processedIds.has(person.id)) return;

                // Add person
                orderedFamilyList.push(person);
                processedIds.add(person.id);

                // Add their spouse chain (includes remarriages)
                addSpouseChain(person, orderedFamilyList, processedIds);

                // Add all their descendants
                const addDescendants = (parentId) => {
                    const children = familyMembers.filter(m => isChildOf(m, parentId));
                    
                    children.sort((a, b) => {
                        if (!a.birthday && !b.birthday) return 0;
                        if (!a.birthday) return 1;
                        if (!b.birthday) return -1;
                        return new Date(a.birthday) - new Date(b.birthday);
                    });

                    children.forEach(child => {
                        if (!processedIds.has(child.id)) {
                            // Add child
                            orderedFamilyList.push(child);
                            processedIds.add(child.id);

                            // Add child's spouse chain (includes remarriages)
                            addSpouseChain(child, orderedFamilyList, processedIds);

                            // Recursively add their children
                            addDescendants(child.id);
                        }
                    });
                };

                addDescendants(person.id);
            });

            // Step 3: Add any remaining people as couples (should be very few if any)
            const remaining = familyMembers.filter(member => !processedIds.has(member.id));
            const remainingProcessed = new Set();

            remaining.forEach(member => {
                if (remainingProcessed.has(member.id)) return;

                // Add person
                orderedFamilyList.push(member);
                remainingProcessed.add(member.id);

                // Add their spouse immediately if in remaining list
                const spouse = findSpouse(member);
                if (spouse && remaining.some(r => r.id == spouse.id) && !remainingProcessed.has(spouse.id)) {
                    orderedFamilyList.push(spouse);
                    remainingProcessed.add(spouse.id);
                }
            });

            return orderedFamilyList;
        }

        // Helper function to get deceased parent info
        function getDeceasedParentInfo(member) {
            let deceasedParents = [];
            
            // Check if they have parent IDs
            if (member.parent_ids && Array.isArray(member.parent_ids)) {
                member.parent_ids.forEach(parentId => {
                    const parent = familyMembers.find(p => p.id == parentId);
                    if (parent && parent.date_of_death) {
                        const gender = guessGender(parent);
                        const prefix = gender === 'female' ? 'Mother:' : gender === 'male' ? 'Father:' : 'Parent:';
                        deceasedParents.push(`${prefix} ${getSimpleDisplayName(parent)}`);
                    }
                });
            }
            
            // Check other_parent field
            if (member.other_parent) {
                deceasedParents.push(`Parent: ${member.other_parent}`);
            }
            
            return deceasedParents;
        }

        // Helper function to add spouse chain (handles remarriages)
        function addSpouseChain(person, orderedFamilyList, processedIds) {
            const spouse = findSpouse(person);
            if (spouse && !processedIds.has(spouse.id)) {
                // Add the spouse
                orderedFamilyList.push(spouse);
                processedIds.add(spouse.id);
                
                // Check if the spouse has a NEW spouse (remarriage)
                const spouseNewSpouse = findSpouse(spouse);
                if (spouseNewSpouse && spouseNewSpouse.id != person.id && !processedIds.has(spouseNewSpouse.id)) {
                    // Add the spouse's new spouse
                    orderedFamilyList.push(spouseNewSpouse);
                    processedIds.add(spouseNewSpouse.id);
                }
            }
        }
        function isNextPersonSpouse(member, orderedFamily, currentIndex) {
            if (currentIndex + 1 >= orderedFamily.length) return false;
            const nextPerson = orderedFamily[currentIndex + 1];
            const spouse = findSpouse(member);
            return spouse && spouse.id == nextPerson.id;
        }

        // Helper function to check if previous person in list is spouse  
        function isPreviousPersonSpouse(member, orderedFamily, currentIndex) {
            if (currentIndex - 1 < 0) return false;
            const previousPerson = orderedFamily[currentIndex - 1];
            const spouse = findSpouse(member);
            return spouse && spouse.id == previousPerson.id;
        }
        function getLivingSpouseInfo(member) {
            const spouse = findSpouse(member);
            if (spouse && !spouse.date_of_death) {
                return `Spouse: ${getSimpleDisplayName(spouse)}`;
            }
            return null;
        }
        function guessGender(person) {
            const firstName = person.full_name.trim().split(' ')[0].toLowerCase();
            
            // Common male names
            const maleNames = ['john', 'james', 'robert', 'michael', 'william', 'david', 'richard', 'joseph', 'thomas', 'christopher', 'charles', 'daniel', 'matthew', 'anthony', 'mark', 'donald', 'steven', 'paul', 'andrew', 'joshua', 'kenneth', 'kevin', 'brian', 'george', 'edward', 'ronald', 'timothy', 'jason', 'jeffrey', 'ryan', 'jacob', 'gary', 'nicholas', 'eric', 'jonathan', 'stephen', 'larry', 'justin', 'scott', 'brandon', 'benjamin', 'samuel', 'gregory', 'alexander', 'patrick', 'frank', 'raymond', 'jack', 'dennis', 'jerry', 'tyler', 'aaron', 'jose', 'henry', 'adam', 'douglas', 'nathan', 'peter', 'zachary', 'kyle', 'walter', 'harold', 'carl', 'arthur', 'gerald', 'roger', 'keith', 'jeremy', 'lawrence', 'sean', 'christian', 'ethan', 'austin', 'joe', 'albert', 'wayne', 'mason', 'roy', 'ralph', 'eugene', 'louis', 'philip', 'bobby'];
            
            // Common female names  
            const femaleNames = ['mary', 'patricia', 'jennifer', 'linda', 'elizabeth', 'barbara', 'susan', 'jessica', 'sarah', 'karen', 'nancy', 'lisa', 'betty', 'helen', 'sandra', 'donna', 'carol', 'ruth', 'sharon', 'michelle', 'laura', 'sarah', 'kimberly', 'deborah', 'dorothy', 'lisa', 'nancy', 'karen', 'betty', 'helen', 'sandra', 'donna', 'carol', 'ruth', 'sharon', 'michelle', 'laura', 'sarah', 'kimberly', 'deborah', 'dorothy', 'amy', 'angela', 'ashley', 'brenda', 'emma', 'olivia', 'cynthia', 'marie', 'janet', 'catherine', 'frances', 'christine', 'samantha', 'debra', 'rachel', 'carolyn', 'janet', 'virginia', 'maria', 'heather', 'diane', 'julie', 'joyce', 'victoria', 'kelly', 'christina', 'joan', 'evelyn', 'lauren', 'judith', 'megan', 'cheryl', 'andrea', 'hannah', 'jacqueline', 'martha', 'gloria', 'teresa', 'sara', 'janice', 'marie', 'julia', 'heather', 'diane', 'ruth', 'julie', 'joyce', 'virginia'];
            
            if (maleNames.includes(firstName)) return 'male';
            if (femaleNames.includes(firstName)) return 'female';
            
            // Check if they have a maiden name (likely female)
            if (person.maiden_name) return 'female';
            
            return 'unknown';
        }
        function hasAnyParents(member) {
            if (member.parent_id) return true; // Old format
            if (member.parent_ids && member.parent_ids.length > 0) return true; // New format
            if (member.other_parent) return true; // Written-in parent
            return false;
        }

        // Helper function to check if someone is a child of a specific parent
        function isChildOf(member, parentId) {
            if (member.parent_id == parentId) return true; // Old format
            if (member.parent_ids && member.parent_ids.includes(parentId)) return true; // New format
            return false;
        }

        // Update directory view (WITHOUT health info showing)
        function updateDirectoryView() {
            const list = document.getElementById('family-list');
            const count = document.getElementById('member-count');
            
            count.textContent = familyMembers.length;

            if (familyMembers.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <p style="font-size: 20px; margin-bottom: 8px;">No family members added yet</p>
                        <p>Click "Add/Edit Person" above to get started!</p>
                    </div>
                `;
                return;
            }

            const orderedFamily = buildFamilyTree();
            
            let html = '';
            orderedFamily.forEach((member, index) => {
                const displayName = getDisplayName(member);
                const formattedBirthday = member.birthday ? formatDateDisplay(member.birthday) : 'No birthday recorded';
                
                let nameAndDate = `${displayName} - ${formattedBirthday}`;
                if (member.date_of_death) {
                    const deathDate = formatDateDisplay(member.date_of_death);
                    const wouldBeAge = calculateAge(member.birthday, member.date_of_death);
                    nameAndDate += `, died ${deathDate} - would be ${wouldBeAge}`;
                }
                
                let detailsParts = [];
                if (member.address) detailsParts.push(member.address);
                if (member.phone) detailsParts.push(member.phone);
                if (member.anniversary) detailsParts.push(`Anniversary: ${formatDateDisplay(member.anniversary)}`);
                if (member.email) detailsParts.push(member.email);
                if (member.instagram) detailsParts.push(member.instagram);
                
                // Get deceased parent info
                const deceasedParents = getDeceasedParentInfo(member);
                
                // Check spouse grouping
                const isSpouseNext = isNextPersonSpouse(member, orderedFamily, index);
                const isSpousePrevious = isPreviousPersonSpouse(member, orderedFamily, index);
                
                let spouseInfo = null;
                if (isSpouseNext) {
                    spouseInfo = "Spouse: Next person listed";
                } else if (isSpousePrevious) {
                    spouseInfo = "Spouse: Previous person listed";
                } else {
                    // Show spouse name if not grouped
                    const livingSpouse = getLivingSpouseInfo(member);
                    if (livingSpouse) {
                        spouseInfo = livingSpouse;
                    }
                }
                
                const editOnclick = `editMember('${member.id}')`;
                const deleteOnclick = `deleteMember('${member.id}')`;
                
                html += `
                    <div class="person-entry">
                        <div class="person-first-line">
                            ${nameAndDate} 
                            <button class="small-btn" onclick="${editOnclick}">‚úèÔ∏è</button>
                            <button class="small-btn red" onclick="${deleteOnclick}">üóëÔ∏è</button>
                        </div>
                        ${deceasedParents.length > 0 ? `<div style="font-size: 11px; color: #666; margin: 2px 0;">${deceasedParents.join(' ‚Ä¢ ')}</div>` : ''}
                        ${spouseInfo ? `<div style="font-size: 11px; color: #666; margin: 2px 0;">${spouseInfo}</div>` : ''}
                        ${detailsParts.length > 0 ? `<div class="person-details">${detailsParts.join(' ‚Ä¢ ')}</div>` : ''}
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // Update health view
        function updateHealthView() {
            const list = document.getElementById('health-list');
            const membersWithHealth = familyMembers.filter(member => member.health_info && member.health_info.trim());
            
            if (membersWithHealth.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üè•</div>
                        <p style="font-size: 20px;">No health information recorded yet</p>
                        <p>Add health information to family members to see it here!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            membersWithHealth.forEach((member, index) => {
                const displayName = getDisplayName(member);
                
                html += `
                    <div style="margin-bottom: ${index < membersWithHealth.length - 1 ? '20px' : '0'};">
                        <div style="line-height: 1; margin-bottom: 5px;">
                            <strong>${displayName}</strong>
                            <button class="small-btn" onclick="editMember('${member.id}')" style="margin-left: 8px;">‚úèÔ∏è</button>
                        </div>
                        <div style="line-height: 1; font-size: 14px; color: #333;">${member.health_info}</div>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // Update birthday calendar
        function updateBirthdayCalendarView() {
            const list = document.getElementById('birthday-calendar-list');
            
            if (familyMembers.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üéÇ</div>
                        <p style="font-size: 20px;">No birthdays recorded yet</p>
                        <p>Add family members with birthdays to see the calendar!</p>
                    </div>
                `;
                return;
            }

            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const birthdaysByMonth = {};
            monthNames.forEach(month => birthdaysByMonth[month] = []);

            familyMembers
                .filter(member => member.birthday)
                .forEach(member => {
                    const birthDate = getDateForSorting(member.birthday);
                    const monthName = monthNames[birthDate.getMonth()];
                    const age = calculateAge(member.birthday, member.date_of_death);
                    const displayName = getSimpleDisplayName(member);
                    const formattedDate = formatDateDisplay(member.birthday);
                    
                    let birthdayText = `${displayName} - ${formattedDate}`;
                    if (member.date_of_death) {
                        const deathDate = formatDateDisplay(member.date_of_death);
                        birthdayText += `, died ${deathDate} - would be ${age}`;
                    } else {
                        birthdayText += ` - Age ${age}`;
                    }
                    
                    birthdaysByMonth[monthName].push({
                        date: member.birthday,
                        text: birthdayText,
                        sortDate: birthDate.getDate()
                    });
                });

            Object.keys(birthdaysByMonth).forEach(month => {
                birthdaysByMonth[month].sort((a, b) => a.sortDate - b.sortDate);
            });

            let html = '';
            monthNames.forEach(month => {
                const birthdays = birthdaysByMonth[month];
                if (birthdays.length > 0) {
                    html += `<div class="month-header">${month}</div>`;
                    
                    birthdays.forEach(birthday => {
                        html += `
                            <div class="calendar-item">
                                ${birthday.text}
                            </div>
                        `;
                    });
                }
            });

            if (html === '') {
                html = `
                    <div class="empty-state">
                        <div class="empty-icon">üéÇ</div>
                        <p style="font-size: 20px;">No birthdays recorded yet</p>
                        <p>Add family members with birthdays to see the calendar!</p>
                    </div>
                `;
            }

            list.innerHTML = html;
        }

        // Update anniversary calendar
        function updateAnniversaryCalendarView() {
            const list = document.getElementById('anniversary-calendar-list');
            
            // Filter out deceased members from anniversaries
            const anniversaries = familyMembers.filter(member => 
                member.anniversary && !member.date_of_death
            );
            
            if (anniversaries.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üíç</div>
                        <p style="font-size: 20px;">No anniversaries recorded yet</p>
                        <p>Add anniversary dates to see the calendar!</p>
                    </div>
                `;
                return;
            }

            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const anniversariesByMonth = {};
            monthNames.forEach(month => anniversariesByMonth[month] = []);

            const processedCouples = new Set();

            anniversaries.forEach(member => {
                if (processedCouples.has(member.id)) return;

                const anniversaryDate = getDateForSorting(member.anniversary);
                const monthName = monthNames[anniversaryDate.getMonth()];
                
                const years = new Date().getFullYear() - anniversaryDate.getFullYear();
                
                const parts = member.anniversary.split('-');
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                const year = parts[0];
                const dateFormatted = `${month}/${day}/${year}`;
                
                const spouse = findSpouse(member);
                
                // Only include if spouse is also living
                if (spouse && !spouse.date_of_death) {
                    const name1 = getSimpleDisplayName(member);
                    const name2 = getSimpleDisplayName(spouse);
                    
                    anniversariesByMonth[monthName].push({
                        text: `${dateFormatted} ${name1} & ${name2} - ${years} yrs`,
                        sortDate: anniversaryDate.getDate()
                    });
                    
                    processedCouples.add(member.id);
                    processedCouples.add(spouse.id);
                } else if (!spouse) {
                    // Single person with anniversary (rare case)
                    const displayName = getSimpleDisplayName(member);
                    
                    anniversariesByMonth[monthName].push({
                        text: `${dateFormatted} ${displayName} - ${years} yrs`,
                        sortDate: anniversaryDate.getDate()
                    });
                    
                    processedCouples.add(member.id);
                }
            });

            Object.keys(anniversariesByMonth).forEach(month => {
                anniversariesByMonth[month].sort((a, b) => a.sortDate - b.sortDate);
            });

            let html = '';
            monthNames.forEach(month => {
                const monthAnniversaries = anniversariesByMonth[month];
                if (monthAnniversaries.length > 0) {
                    html += `<div class="month-header">${month}</div>`;
                    
                    monthAnniversaries.forEach(anniversary => {
                        html += `
                            <div class="calendar-item">
                                ${anniversary.text}
                            </div>
                        `;
                    });
                }
            });

            list.innerHTML = html;
        }

        // Update addresses view
        function updateAddressesView() {
            const list = document.getElementById('addresses-list');
            const addressMap = new Map();
            
            const livingMembers = familyMembers.filter(member => !member.date_of_death);
            
            livingMembers
                .filter(member => member.address && member.address.trim())
                .forEach(member => {
                    const address = member.address.trim();
                    if (!addressMap.has(address)) {
                        addressMap.set(address, []);
                    }
                    addressMap.get(address).push(member);
                });
            
            livingMembers
                .filter(member => member.parent_id && (!member.address || !member.address.trim()))
                .forEach(child => {
                    const parent = familyMembers.find(p => p.id === child.parent_id);
                    if (parent && parent.address && parent.address.trim()) {
                        const address = parent.address.trim();
                        if (addressMap.has(address)) {
                            if (!addressMap.get(address).some(m => m.id === child.id)) {
                                addressMap.get(address).push(child);
                            }
                        }
                    }
                });
            
            const addresses = Array.from(addressMap.entries());

            if (addresses.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üè†</div>
                        <p style="font-size: 20px;">No addresses recorded yet</p>
                        <p>Add addresses to family members to see them here!</p>
                    </div>
                `;
                return;
            }

            let addressEntries = [];
            addresses.forEach(([address, members]) => {
                const processedIds = new Set();
                let displayNames = [];
                
                members.forEach(member => {
                    if (processedIds.has(member.id)) return;
                    
                    const spouse = findSpouse(member);
                    
                    if (spouse && members.some(m => m.id == spouse.id)) {
                        const lastName = member.full_name.split(' ').pop();
                        const firstName1 = member.preferred_name || member.full_name.split(' ')[0];
                        const firstName2 = spouse.preferred_name || spouse.full_name.split(' ')[0];
                        displayNames.push(`${lastName}, ${firstName1} & ${firstName2}`);
                        processedIds.add(member.id);
                        processedIds.add(spouse.id);
                    } else if (!processedIds.has(member.id)) {
                        const lastName = member.full_name.split(' ').pop();
                        const firstName = member.preferred_name || member.full_name.split(' ')[0];
                        displayNames.push(`${lastName}, ${firstName}`);
                        processedIds.add(member.id);
                    }
                });
                
                const names = displayNames.join(', ');
                const sortKey = displayNames[0] ? displayNames[0].split(',')[0] : 'Unknown';
                addressEntries.push({ names, address, sortKey });
            });

            addressEntries.sort((a, b) => a.sortKey.localeCompare(b.sortKey));

            let html = '';
            addressEntries.forEach(entry => {
                html += `<div class="address-item">${entry.names} ${entry.address}</div>`;
            });

            list.innerHTML = html;
        }

        // Update phone list view
        function updatePhoneListView() {
            const list = document.getElementById('phone-directory-list');
            
            const membersWithPhones = familyMembers.filter(member => 
                member.phone && member.phone.trim()
            );
            
            if (membersWithPhones.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìû</div>
                        <p style="font-size: 20px;">No phone numbers recorded yet</p>
                        <p>Add phone numbers to family members to see the directory!</p>
                    </div>
                `;
                return;
            }

            membersWithPhones.sort((a, b) => {
                const nameA = getSimpleDisplayName(a).toLowerCase();
                const nameB = getSimpleDisplayName(b).toLowerCase();
                return nameA.localeCompare(nameB);
            });

            let html = '';
            membersWithPhones.forEach(member => {
                const displayName = getSimpleDisplayName(member);
                html += `
                    <div class="phone-item">
                        <span class="phone-name">${displayName}</span>
                        <span>${member.phone}</span>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // Auto-format dates and phone as user types
        document.addEventListener('DOMContentLoaded', function() {
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    e.target.value = formatPhoneNumber(e.target.value);
                });
            }

            // Add date formatting to date inputs
            const birthdayInput = document.getElementById('birthday');
            const anniversaryInput = document.getElementById('anniversary');
            const deathDateInput = document.getElementById('dateOfDeath');

            if (birthdayInput) {
                birthdayInput.addEventListener('input', function(e) {
                    formatDateInput(e.target);
                });
            }

            if (anniversaryInput) {
                anniversaryInput.addEventListener('input', function(e) {
                    formatDateInput(e.target);
                });
            }

            if (deathDateInput) {
                deathDateInput.addEventListener('input', function(e) {
                    formatDateInput(e.target);
                });
            }
        });

        // Export to Word document (main directory)
        function exportToWord() {
            if (familyMembers.length === 0) {
                alert('No family members to export. Please add some family members first.');
                return;
            }

            const orderedFamily = buildFamilyTree();
            let docContent = `${currentDirectoryName}\n\n`;
            
            orderedFamily.forEach(member => {
                const displayName = getDisplayName(member);
                const formattedBirthday = member.birthday ? formatDateDisplay(member.birthday) : 'No birthday recorded';
                
                docContent += `${displayName} - ${formattedBirthday}\n`;
                
                if (member.date_of_death) {
                    const deathDate = formatDateDisplay(member.date_of_death);
                    const wouldBeAge = calculateAge(member.birthday, member.date_of_death);
                    docContent += `Died: ${deathDate} - would be ${wouldBeAge}\n`;
                }
                
                if (member.phone) docContent += `Phone: ${member.phone}\n`;
                if (member.email) docContent += `Email: ${member.email}\n`;
                if (member.address) docContent += `Address: ${member.address}\n`;
                if (member.anniversary) docContent += `Anniversary: ${formatDateDisplay(member.anniversary)}\n`;
                if (member.instagram) docContent += `Instagram: ${member.instagram}\n`;
                if (member.health_info) docContent += `Health: ${member.health_info}\n`;
                
                docContent += '\n';
            });
            
            const blob = new Blob([docContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentDirectoryName.replace(' Directory', '')}_Family_Directory.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Family directory exported successfully!');
        }

        // Export all documents
        function exportAll() {
            if (familyMembers.length === 0) {
                alert('No family members to export. Please add some family members first.');
                return;
            }

            if (confirm('This will export all available documents (Directory, Birthdays, Anniversaries, Addresses, Health Info, and Phone List). Continue?')) {
                // Export main directory
                exportToWord();
                
                // Add small delays between exports to prevent browser issues
                setTimeout(() => exportBirthdays(), 500);
                setTimeout(() => exportAnniversaries(), 1000);
                setTimeout(() => exportAddresses(), 1500);
                setTimeout(() => exportHealthInfo(), 2000);
                setTimeout(() => exportPhoneList(), 2500);
                
                setTimeout(() => {
                    alert('‚úÖ All documents exported successfully!');
                }, 3000);
            }
        }

        // Export birthday calendar to Word document
        function exportBirthdays() {
            if (familyMembers.length === 0) {
                alert('No family members to export.');
                return;
            }

            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            let docContent = `${currentDirectoryName} - Birthday Calendar\n\n`;
            
            const birthdaysByMonth = {};
            monthNames.forEach(month => birthdaysByMonth[month] = []);

            familyMembers
                .filter(member => member.birthday)
                .forEach(member => {
                    const birthDate = getDateForSorting(member.birthday);
                    const monthName = monthNames[birthDate.getMonth()];
                    const age = calculateAge(member.birthday, member.date_of_death);
                    const displayName = getSimpleDisplayName(member);
                    const formattedDate = formatDateDisplay(member.birthday);
                    
                    let birthdayText = `${displayName} - ${formattedDate}`;
                    if (member.date_of_death) {
                        const deathDate = formatDateDisplay(member.date_of_death);
                        birthdayText += `, died ${deathDate} - would be ${age}`;
                    } else {
                        birthdayText += ` - Age ${age}`;
                    }
                    
                    birthdaysByMonth[monthName].push({
                        text: birthdayText,
                        sortDate: birthDate.getDate()
                    });
                });

            Object.keys(birthdaysByMonth).forEach(month => {
                birthdaysByMonth[month].sort((a, b) => a.sortDate - b.sortDate);
            });

            monthNames.forEach(month => {
                const birthdays = birthdaysByMonth[month];
                if (birthdays.length > 0) {
                    docContent += `${month}\n`;
                    birthdays.forEach(birthday => {
                        docContent += `${birthday.text}\n`;
                    });
                    docContent += '\n';
                }
            });
            
            const blob = new Blob([docContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentDirectoryName.replace(' Directory', '')}_Birthday_Calendar.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Birthday calendar exported successfully!');
        }

        // Export anniversary calendar to Word document
        function exportAnniversaries() {
            const anniversaries = familyMembers.filter(member => 
                member.anniversary && !member.date_of_death
            );
            
            if (anniversaries.length === 0) {
                alert('No anniversaries to export.');
                return;
            }

            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            let docContent = `${currentDirectoryName} - Anniversary Calendar\n\n`;
            
            const anniversariesByMonth = {};
            monthNames.forEach(month => anniversariesByMonth[month] = []);
            const processedCouples = new Set();

            anniversaries.forEach(member => {
                if (processedCouples.has(member.id)) return;

                const anniversaryDate = getDateForSorting(member.anniversary);
                const monthName = monthNames[anniversaryDate.getMonth()];
                const years = new Date().getFullYear() - anniversaryDate.getFullYear();
                const parts = member.anniversary.split('-');
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                const year = parts[0];
                const dateFormatted = `${month}/${day}/${year}`;
                const spouse = findSpouse(member);
                
                if (spouse && !spouse.date_of_death) {
                    const name1 = getSimpleDisplayName(member);
                    const name2 = getSimpleDisplayName(spouse);
                    anniversariesByMonth[monthName].push({
                        text: `${dateFormatted} ${name1} & ${name2} - ${years} yrs`,
                        sortDate: anniversaryDate.getDate()
                    });
                    processedCouples.add(member.id);
                    processedCouples.add(spouse.id);
                } else if (!spouse) {
                    const displayName = getSimpleDisplayName(member);
                    anniversariesByMonth[monthName].push({
                        text: `${dateFormatted} ${displayName} - ${years} yrs`,
                        sortDate: anniversaryDate.getDate()
                    });
                    processedCouples.add(member.id);
                }
            });

            Object.keys(anniversariesByMonth).forEach(month => {
                anniversariesByMonth[month].sort((a, b) => a.sortDate - b.sortDate);
            });

            monthNames.forEach(month => {
                const monthAnniversaries = anniversariesByMonth[month];
                if (monthAnniversaries.length > 0) {
                    docContent += `${month}\n`;
                    monthAnniversaries.forEach(anniversary => {
                        docContent += `${anniversary.text}\n`;
                    });
                    docContent += '\n';
                }
            });
            
            const blob = new Blob([docContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentDirectoryName.replace(' Directory', '')}_Anniversary_Calendar.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Anniversary calendar exported successfully!');
        }

        // Export addresses to Word document
        function exportAddresses() {
            const addressMap = new Map();
            const livingMembers = familyMembers.filter(member => !member.date_of_death);
            
            livingMembers
                .filter(member => member.address && member.address.trim())
                .forEach(member => {
                    const address = member.address.trim();
                    if (!addressMap.has(address)) {
                        addressMap.set(address, []);
                    }
                    addressMap.get(address).push(member);
                });
            
            const addresses = Array.from(addressMap.entries());
            
            if (addresses.length === 0) {
                alert('No addresses to export.');
                return;
            }

            let docContent = `${currentDirectoryName} - Address Directory\n\n`;
            
            let addressEntries = [];
            addresses.forEach(([address, members]) => {
                const processedIds = new Set();
                let displayNames = [];
                
                members.forEach(member => {
                    if (processedIds.has(member.id)) return;
                    const spouse = findSpouse(member);
                    
                    if (spouse && members.some(m => m.id == spouse.id)) {
                        const lastName = member.full_name.split(' ').pop();
                        const firstName1 = member.preferred_name || member.full_name.split(' ')[0];
                        const firstName2 = spouse.preferred_name || spouse.full_name.split(' ')[0];
                        displayNames.push(`${lastName}, ${firstName1} & ${firstName2}`);
                        processedIds.add(member.id);
                        processedIds.add(spouse.id);
                    } else if (!processedIds.has(member.id)) {
                        const lastName = member.full_name.split(' ').pop();
                        const firstName = member.preferred_name || member.full_name.split(' ')[0];
                        displayNames.push(`${lastName}, ${firstName}`);
                        processedIds.add(member.id);
                    }
                });
                
                const names = displayNames.join(', ');
                const sortKey = displayNames[0] ? displayNames[0].split(',')[0] : 'Unknown';
                addressEntries.push({ names, address, sortKey });
            });

            addressEntries.sort((a, b) => a.sortKey.localeCompare(b.sortKey));
            addressEntries.forEach(entry => {
                docContent += `${entry.names}\n${entry.address}\n\n`;
            });
            
            const blob = new Blob([docContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentDirectoryName.replace(' Directory', '')}_Address_Directory.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Address directory exported successfully!');
        }

        // Export health information to Word document
        function exportHealthInfo() {
            const membersWithHealth = familyMembers.filter(member => member.health_info && member.health_info.trim());
            
            if (membersWithHealth.length === 0) {
                alert('No health information to export.');
                return;
            }

            let docContent = `${currentDirectoryName} - Health Information\n\n`;
            
            membersWithHealth.forEach(member => {
                const displayName = getDisplayName(member);
                docContent += `${displayName}\n${member.health_info}\n\n`;
            });
            
            const blob = new Blob([docContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentDirectoryName.replace(' Directory', '')}_Health_Information.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Health information exported successfully!');
        }

        // Export phone list to Word document
        function exportPhoneList() {
            const membersWithPhones = familyMembers.filter(member => 
                member.phone && member.phone.trim()
            );
            
            if (membersWithPhones.length === 0) {
                alert('No phone numbers to export.');
                return;
            }

            membersWithPhones.sort((a, b) => {
                const nameA = getSimpleDisplayName(a).toLowerCase();
                const nameB = getSimpleDisplayName(b).toLowerCase();
                return nameA.localeCompare(nameB);
            });

            let docContent = `${currentDirectoryName} - Phone Directory\n\n`;
            
            membersWithPhones.forEach(member => {
                const displayName = getSimpleDisplayName(member);
                docContent += `${displayName} - ${member.phone}\n`;
            });
            
            const blob = new Blob([docContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentDirectoryName.replace(' Directory', '')}_Phone_Directory.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Phone directory exported successfully!');
        }

        // Make sure functions are available globally
        window.showCreateForm = showCreateForm;
        window.showJoinForm = showJoinForm;
        window.hideStartupForms = hideStartupForms;
        window.createDirectory = createDirectory;
        window.joinDirectory = joinDirectory;
        window.leaveDirectory = leaveDirectory;
        window.showInviteCode = showInviteCode;
        window.copyInviteCode = copyInviteCode;
        window.closeInviteModal = closeInviteModal;
        window.showTab = showTab;
        window.clearForm = clearForm;
        window.addOrUpdateMember = addOrUpdateMember;
        window.editMember = editMember;
        window.deleteMember = deleteMember;
        window.exportToWord = exportToWord;
        window.exportBirthdays = exportBirthdays;
        window.exportAnniversaries = exportAnniversaries;
        window.exportAddresses = exportAddresses;
        window.exportHealthInfo = exportHealthInfo;
        window.exportPhoneList = exportPhoneList;

        console.log('‚úÖ Testing version loaded successfully');
    </script>
</body>
</html>
